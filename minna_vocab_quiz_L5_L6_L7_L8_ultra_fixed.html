<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>å¤§å®¶çš„æ—¥æœ¬èª N5ï½œL5â€“L8 å–®å­—å°è€ƒï¼ˆå›ºå®šé¡Œåº«ï¼‰</title>
  <style>
    :root{ --bg1:#fff6dc; --bg2:#ffeec5; --paper:#fff7da; --ink:#1d1608; --accent:#d9983d; --accent-d:#b67a2f; --ok:#2e7d32; --bad:#c62828; --shadow:0 10px 20px rgba(0,0,0,.08); }
    html,body{height:100%}
    body{margin:0;font-family: ui-rounded,"SF Pro Rounded",-apple-system,system-ui,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif;color:var(--ink);
      background: radial-gradient(120% 120% at 0% 0%, var(--bg1), var(--bg2)); background-attachment:fixed; -webkit-tap-highlight-color: transparent;}
    .app{min-height:100dvh;display:flex;flex-direction:column}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 14px;background:color-mix(in oklab,#fff 70%,transparent);backdrop-filter: blur(6px);border-bottom:1px dashed rgba(0,0,0,.08)}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:14px;background:var(--paper);display:grid;place-items:center;font-weight:900;color:var(--accent);box-shadow:inset 0 0 0 2px rgba(0,0,0,.06)}
    .title{font-weight:900;color:var(--accent)}
    .hud{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .chip{background:var(--paper);padding:6px 10px;border-radius:999px;font-weight:900;box-shadow:var(--shadow)}
    .home-link{ text-decoration:none;background:#fff;color:var(--accent); font-weight:900;border-radius:999px;padding:6px 12px; box-shadow:inset 0 0 0 2px var(--accent);transition:background .1s }
    .home-link:hover{background:var(--paper)}
    main{flex:1;padding:14px;display:flex}
    .card{margin:auto;width:min(1000px,100%);background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:18px;box-shadow:var(--shadow);padding:16px 14px}
    .section{display:flex;flex-direction:column;gap:12px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:900;box-shadow:0 6px 0 var(--accent-d)}
    .btn:active{transform:translateY(2px);box-shadow:0 4px 0 var(--accent-d)}
    .ghost{background:#fff;color:var(--accent);box-shadow: inset 0 0 0 2px var(--accent)}
    .pill{background:#fff;border:1px solid rgba(0,0,0,.08);padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800}
    .title2{font-weight:900;color:#5f430e}
    .qtext{display:flex;align-items:center;gap:10px;font-size:1.6rem;font-weight:900;line-height:1.6;word-break:keep-all}
    .starbtn{border:0;background:transparent;font-size:1.4rem;cursor:pointer}
    .star-on{color:#f4b400;filter:drop-shadow(0 1px 0 rgba(0,0,0,.2))}
    .choices{display:grid;grid-template-columns:1fr;gap:10px}
    .choice{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:14px 12px;font-size:1.1rem;font-weight:800;box-shadow:var(--shadow)}
    .choice:active{transform:scale(.99)}
    .key{min-width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:var(--paper);color:var(--accent);border:1px solid rgba(0,0,0,.06)}
    .result{margin-top:10px;padding:10px;border-radius:12px;border:2px dashed rgba(0,0,0,.12);display:none}
    .result.ok{border-color: color-mix(in oklab, var(--ok) 40%, transparent)}
    .result.bad{border-color: color-mix(in oklab, var(--bad) 40%, transparent)}
    footer{position:sticky;bottom:0;z-index:10;padding:8px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px;background:color-mix(in oklab,#fff 70%,transparent);backdrop-filter: blur(6px);border-top:1px dashed rgba(0,0,0,.08)}
    .meter{flex:1;display:flex;gap:10px;align-items:center}
    .progress{height:12px;background:#fff;border:1px solid rgba(0,0,0,.1);border-radius:999px;overflow:hidden;flex:1}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#d9983d,#f7c66d)}
    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:8px}
    .item{background:var(--paper);padding:10px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .hint{opacity:.85;font-size:.95rem}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#fff;border:1px solid rgba(0,0,0,.1);padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">å˜</div>
        <div class="title">å¤§å®¶çš„æ—¥æœ¬èª N5ï½œL5â€“L8 å–®å­—å°è€ƒï¼ˆå›ºå®šé¡Œåº«ï¼‰</div>
      </div>
      <div class="hud">
        <div class="chip">åˆ†æ•¸ <span id="score">0</span></div>
        <div class="chip">é€£å° <span id="streak">0</span></div>
        <div class="chip" id="timeChip" style="display:none">â± <span id="timeLeft">60</span>s</div>
        <a href="index.html" class="home-link">ğŸ  å›é¦–é </a>
      </div>
    </header>

    <main>
      <section class="card section" id="setup">
        <div class="title2">æ¨¡å¼</div>
        <div class="grid">
          <label class="row"><input type="radio" name="mode" value="jp2zh" checked> <span class="pill">çœ‹åˆ°æ—¥æ–‡ â†’ é¸ä¸­æ–‡</span></label>
          <label class="row"><input type="radio" name="mode" value="zh2jp"> <span class="pill">çœ‹åˆ°ä¸­æ–‡ â†’ é¸æ—¥æ–‡</span></label>
          <label class="row"><input type="radio" name="mode" value="kanji2kana"> <span class="pill">è®€éŸ³æ¨¡å¼ï¼šæ¼¢å­— â†’ å‡å</span></label>
        </div>

        <div class="title2">ç¯„åœ</div>
        <div class="row">
          <label class="pill"><input type="checkbox" id="useL5" checked> L5</label>
          <label class="pill"><input type="checkbox" id="useL6" checked> L6</label>
          <label class="pill"><input type="checkbox" id="useL7" checked> L7</label>
          <label class="pill"><input type="checkbox" id="useL8" checked> L8</label>
        </div>

        <div class="title2">æ¨™ç±¤ç¯©é¸</div>
        <div class="row">
          <label class="pill"><input type="checkbox" id="tagSuffix"> æ¥å°¾è©</label>
          <label class="pill"><input type="checkbox" id="tagCountry"> åœ‹å®¶</label>
          <label class="pill"><input type="checkbox" id="tagTime"> æ™‚é–“é¡</label>
          <span class="pill"><input type="checkbox" id="onlyStar"> åªå‡º â­ï¸ æ˜Ÿè™Ÿå–®å­—</span>
        </div>

        <div class="title2">é¡Œæ•¸ & é™æ™‚</div>
        <div class="row">
          <button class="pill" data-q="10">10 é¡Œ</button>
          <button class="pill" data-q="20">20 é¡Œ</button>
          <span id="qcount" class="pill">ç›®å‰ï¼š10 é¡Œ</span>
        </div>
        <div class="row">
          <label class="pill"><input type="checkbox" id="timed"> é™æ™‚æ¨¡å¼ï¼ˆ60 ç§’ï¼Œé€£å° +3 ç§’ï¼‰</label>
          <label class="pill"><input type="checkbox" id="byLesson"> ä¾èª²æ¬¡é †åºï¼ˆé—œé–‰ï¼éš¨æ©Ÿæ··åˆï¼‰</label>
          <label class="pill"><input type="checkbox" id="katakana"> åªé¡¯ç¤ºç‰‡å‡å</label>
          <label class="pill"><input type="checkbox" id="showKanji" checked> é¡¯ç¤ºæ¼¢å­—</label>
        </div>

        <details>
          <summary>é¡Œåº«ä¸€è¦½ï¼ˆå¯ç›´æ¥åŠ æ˜Ÿï¼‰</summary>
          <div class="title2" style="margin-top:6px">L5</div>
          <div class="list" id="bankL5"></div>
          <div class="title2" style="margin-top:10px">L6</div>
          <div class="list" id="bankL6"></div>
          <div class="title2" style="margin-top:10px">L7</div>
          <div class="list" id="bankL7"></div>
          <div class="title2" style="margin-top:10px">L8</div>
          <div class="list" id="bankL8"></div>
        </details>

        <div class="hint">å¿«æ·éµï¼š<span class="kbd">A</span>/<span class="kbd">B</span>/<span class="kbd">C</span> ä½œç­”ï¼Œ<span class="kbd">Enter</span> ä¸‹ä¸€é¡Œï¼Œ<span class="kbd">Space</span> æœ—è®€</div>
        <div class="row"><button class="btn" id="startBtn">é–‹å§‹æ¸¬é©— â–¶</button></div>
      </section>

      <section class="card section" id="quiz" style="display:none">
        <div class="row"><span class="pill" id="meta">ç¬¬ 1 / 10 é¡Œ</span><span class="pill" id="modeTag">JPâ†’ZH</span></div>
        <div class="qtext" id="qtext">å•é¡Œ</div>
        <div class="choices" id="choices"></div>
        <div class="result" id="resultBox">
          <div id="resHead" style="font-weight:900;margin-bottom:4px"></div>
          <div id="resBody"></div>
        </div>
        <div class="row">
          <button class="btn" id="nextBtn" disabled>ä¸‹ä¸€é¡Œ â†’</button>
          <button class="ghost" id="speakBtn">æœ—è®€</button>
        </div>
      </section>

      <section class="card section" id="summary" style="display:none">
        <div class="title2">å®Œæˆï¼</div>
        <div>åˆ†æ•¸ï¼š<b id="finalScore">0</b> ï¼ é¡Œæ•¸ï¼š<b id="finalTotal">0</b></div>
        <div>æœ€ä½³é€£å°ï¼š<b id="finalStreak">0</b></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="retryWrong" disabled>éŒ¯é¡Œé‡ç·´ â–¶</button>
          <button class="ghost" id="restart">å›åˆ°è¨­å®šé </button>
        </div>
      </section>
    </main>

    <footer>
      <div class="meter">
        <span class="pill">é€²åº¦</span>
        <div class="progress"><div class="bar" id="bar"></div></div>
      </div>
    </footer>
  </div>

  <script>
    // ---------- å·¥å…·èˆ‡è³‡æ–™ ----------
    const T = { SUFFIX:"æ¥å°¾è©", COUNTRY:"åœ‹å®¶", TIME:"æ™‚é–“" };
    const STORAGE_KEY_STARS = "minna_L5_8_stars";
    const STORAGE_KEY_PREFS = "minna_L5_8_prefs";

    const $ = (s, r=document)=>r.querySelector(s);
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
    function sampleUnique(arr, n, excludeSet=new Set()){
      const pool = arr.filter(x=>!excludeSet.has(x));
      if(n>=pool.length) return shuffle(pool.slice());
      const out=[]; const used=new Set();
      while(out.length<n && used.size<pool.length){
        const it = pool[Math.floor(Math.random()*pool.length)];
        if(!used.has(it)){ out.push(it); used.add(it); }
      }
      return out;
    }
    function hira2kata(str){
      return str.replace(/[\u3041-\u3096]/g,ch=>String.fromCharCode(ch.charCodeAt(0)+0x60));
    }
    function parseKanjiKanaFlexible(jp){
      let m = jp.match(/^(.*)ï¼ˆ(.*)ï¼‰$/);
      if(m){ return {kana:m[1], kanji:m[2]} }
      m = jp.match(/^(.*)\((.*)\)$/);
      if(m){ return {kana:m[1], kanji:m[2]} }
      return {kana:jp, kanji:jp};
    }
    function toObj(jp, zh, tags, l){
      const {kana, kanji} = parseKanjiKanaFlexible(jp.trim());
      const normTags = (tags||[]).map(t=>t.trim()).filter(Boolean);
      return {id:jp.trim()+"__"+zh.trim(), jp:jp.trim(), zh:zh.trim(), kana, kanji, tags:normTags, l};
    }

    // é¡¯ç¤ºæ–‡å­—ï¼šä¾ã€Œé¡¯ç¤ºæ¼¢å­—ï¼ç‰‡å‡åã€åå¥½ç”¢ç”Ÿ
    function displayKana(word, katakanaOn){
      const k = word.kana || word.jp;
      return katakanaOn ? hira2kata(k) : k;
    }
    function displayJP(word, showKanji, katakanaOn){
      if(!showKanji){
        return displayKana(word, katakanaOn); // åªé¡¯ç¤ºå‡å
      }
      // é¡¯ç¤ºã€Œå‡åï¼ˆæ¼¢å­—ï¼‰ã€ï¼›è‹¥æœ¬èº«ç„¡æ¼¢å­—ï¼Œå°±ç›´æ¥é¡¯ç¤º jp æˆ–å‡å
      if(word.kanji && word.kana && word.kanji!==word.kana){
        return `${displayKana(word, katakanaOn)}ï¼ˆ${word.kanji}ï¼‰`;
      }
      // å¤–ä¾†èªæˆ–ç„¡æ¼¢å­—
      const s = word.jp || word.kana;
      return katakanaOn ? hira2kata(s) : s;
    }

    // ---------- é¡Œåº«ï¼ˆèˆ‡ä½ åŸæœ¬ç›¸åŒï¼Œç•¥ï¼‰ ----------
    // L5
    const L5 = [
      toObj("ã„ãã¾ã™ï¼ˆè¡Œãã¾ã™ï¼‰","å»",[], "L5"),
      toObj("ãã¾ã™ï¼ˆæ¥ã¾ã™ï¼‰","ä¾†",[], "L5"),
      toObj("ã‹ãˆã‚Šã¾ã™ï¼ˆå¸°ã‚Šã¾ã™ï¼‰","å›",[], "L5"),
      toObj("ãŒã£ã“ã†ï¼ˆå­¦æ ¡ï¼‰","å­¸æ ¡",[], "L5"),
      toObj("ã‚¹ãƒ¼ãƒ‘ãƒ¼","è¶…å¸‚",[], "L5"),
      toObj("ãˆãï¼ˆé§…ï¼‰","è»Šç«™",[], "L5"),
      toObj("ã²ã“ã†ãï¼ˆé£›è¡Œæ©Ÿï¼‰","é£›æ©Ÿ",[], "L5"),
      toObj("ãµã­ï¼ˆèˆ¹ï¼‰","èˆ¹",[], "L5"),
      toObj("ã§ã‚“ã—ã‚ƒï¼ˆé›»è»Šï¼‰","é›»è»Š",[], "L5"),
      toObj("ã¡ã‹ã¦ã¤ï¼ˆåœ°ä¸‹é‰„ï¼‰","åœ°ä¸‹éµ",[], "L5"),
      toObj("ã—ã‚“ã‹ã‚“ã›ã‚“ï¼ˆæ–°å¹¹ç·šï¼‰","æ–°å¹¹ç·š",[], "L5"),
      toObj("ãƒã‚¹","å…¬è»Šã€å·´å£«",[], "L5"),
      toObj("ã‚¿ã‚¯ã‚·ãƒ¼","è¨ˆç¨‹è»Š",[], "L5"),
      toObj("ã˜ã¦ã‚“ã—ã‚ƒï¼ˆè‡ªè»¢è»Šï¼‰","è‡ªè¡Œè»Šã€è…³è¸è»Š",[], "L5"),
      toObj("ã‚ã‚‹ã„ã¦ï¼ˆæ­©ã„ã¦ï¼‰","æ­¥è¡Œ",[], "L5"),
      toObj("ã²ã¨ï¼ˆäººï¼‰","äºº",[], "L5"),
      toObj("ã¨ã‚‚ã ã¡ï¼ˆå‹é”ï¼‰","æœ‹å‹",[], "L5"),
      toObj("ã‹ã‚Œï¼ˆå½¼ï¼‰","ä»–ã€ç”·æœ‹å‹",[], "L5"),
      toObj("ã‹ã®ã˜ã‚‡ï¼ˆå½¼å¥³ï¼‰","å¥¹ã€å¥³æœ‹å‹",[], "L5"),
      toObj("ã‹ããï¼ˆå®¶æ—ï¼‰","å®¶äººã€å®¶å±¬",[], "L5"),
      toObj("ã²ã¨ã‚Šã§ï¼ˆä¸€äººã§ï¼‰","ä¸€å€‹äººã€è‡ªå·±",[], "L5"),
      toObj("ã›ã‚“ã—ã‚…ã†ï¼ˆå…ˆé€±ï¼‰","ä¸Šé€±ã€ä¸Šæ˜ŸæœŸ",[T.TIME], "L5"),
      toObj("ã“ã‚“ã—ã‚…ã†ï¼ˆä»Šé€±ï¼‰","æœ¬é€±ã€é€™æ˜ŸæœŸ",[T.TIME], "L5"),
      toObj("ã‚‰ã„ã—ã‚…ã†ï¼ˆæ¥é€±ï¼‰","ä¸‹é€±ã€ä¸‹æ˜ŸæœŸ",[T.TIME], "L5"),
      toObj("ã›ã‚“ã’ã¤ï¼ˆå…ˆæœˆï¼‰","ä¸Šå€‹æœˆ",[T.TIME], "L5"),
      toObj("ã“ã‚“ã’ã¤ï¼ˆä»Šæœˆï¼‰","é€™å€‹æœˆ",[T.TIME], "L5"),
      toObj("ã‚‰ã„ã’ã¤ï¼ˆæ¥æœˆï¼‰","ä¸‹å€‹æœˆ",[T.TIME], "L5"),
      toObj("ãã‚‡ã­ã‚“ï¼ˆå»å¹´ï¼‰","å»å¹´",[T.TIME], "L5"),
      toObj("ã“ã¨ã—ï¼ˆä»Šå¹´ï¼‰","ä»Šå¹´",[T.TIME], "L5"),
      toObj("ã‚‰ã„ã­ã‚“ï¼ˆæ¥å¹´ï¼‰","æ˜å¹´",[T.TIME], "L5"),
      toObj("â‹¯ã­ã‚“","...å¹´",[T.TIME], "L5"),
      toObj("ãªã‚“ã­ã‚“ï¼ˆä½•å¹´ï¼‰","å¹¾å¹´",[T.TIME], "L5"),
      toObj("â‹¯ãŒã¤","...æœˆ",[T.TIME], "L5"),
      toObj("ãªã‚“ãŒã¤ï¼ˆä½•æœˆï¼‰","å¹¾æœˆ",[T.TIME], "L5"),
      toObj("ã¤ã„ãŸã¡ï¼ˆ1 æ—¥ï¼‰","1 è™Ÿ",[T.TIME], "L5"),
      toObj("ãµã¤ã‹ï¼ˆ2 æ—¥ï¼‰","2 è™Ÿã€å…©å¤©",[T.TIME], "L5"),
      toObj("ã¿ã£ã‹ï¼ˆ3 æ—¥ï¼‰","3 è™Ÿã€ä¸‰å¤©",[T.TIME], "L5"),
      toObj("ã‚ˆã£ã‹ï¼ˆ4 æ—¥ï¼‰","4 è™Ÿã€å››å¤©",[T.TIME], "L5"),
      toObj("ã„ã¤ã‹ï¼ˆ5 æ—¥ï¼‰","5 è™Ÿã€äº”å¤©",[T.TIME], "L5"),
      toObj("ã‚€ã„ã‹ï¼ˆ6 æ—¥ï¼‰","6 è™Ÿã€å…­å¤©",[T.TIME], "L5"),
      toObj("ãªã®ã‹ï¼ˆ7 æ—¥ï¼‰","7 è™Ÿã€ä¸ƒå¤©",[T.TIME], "L5"),
      toObj("ã‚ˆã†ã‹ï¼ˆ8 æ—¥ï¼‰","8 è™Ÿã€å…«å¤©",[T.TIME], "L5"),
      toObj("ã“ã“ã®ã‹ï¼ˆ9 æ—¥ï¼‰","9 è™Ÿã€ä¹å¤©",[T.TIME], "L5"),
      toObj("ã¨ãŠã‹ï¼ˆ10 æ—¥ï¼‰","10 è™Ÿã€åå¤©",[T.TIME], "L5"),
      toObj("ã˜ã‚…ã†ã‚ˆã£ã‹ï¼ˆ14 æ—¥ï¼‰","14 è™Ÿã€åå››å¤©",[T.TIME], "L5"),
      toObj("ã¯ã¤ã‹ï¼ˆ20 æ—¥ï¼‰","20 è™Ÿã€äºŒåå¤©",[T.TIME], "L5"),
      toObj("ã«ã˜ã‚…ã†ã‚ˆã£ã‹ï¼ˆ24 æ—¥ï¼‰","24 æ—¥ã€äºŒåå››å¤©",[T.TIME], "L5"),
      toObj("â‹¯ã«ã¡ï¼ˆâ€¦æ—¥ï¼‰","...è™Ÿã€...å¤©",[T.TIME], "L5"),
      toObj("ãªã‚“ã«ã¡ï¼ˆä½•æ—¥ï¼‰","å¹¾è™Ÿã€å¹¾å¤©",[T.TIME], "L5"),
      toObj("ã„ã¤","ä»€éº¼æ™‚å€™",[T.TIME], "L5"),
      toObj("ãŸã‚“ã˜ã‚‡ã†ã³ï¼ˆèª•ç”Ÿæ—¥ï¼‰","ç”Ÿæ—¥",[], "L5"),
      toObj("[ã©ã†ã‚‚]ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚","éå¸¸æ„Ÿè¬ã€‚",[], "L5"),
      toObj("ã©ã†ã„ãŸã—ã¾ã—ã¦ã€‚","ä¸å®¢æ°£ã€‚",[], "L5"),
      toObj("â‹¯ã°ã‚“ã›ã‚“ï¼ˆ...ç•ªç·šï¼‰","ç¬¬â‹¯è™Ÿæœˆè‡º",[], "L5"),
      toObj("ã¤ãã®ï¼ˆæ¬¡ã®ï¼‰","ä¸‹ä¸€å€‹ã€ä¸‹ä¸€ç­",[], "L5"),
      toObj("ãµã¤ã†ï¼ˆæ™®é€šï¼‰","æ™®é€šè»Š",[], "L5"),
      toObj("ãã‚…ã†ã“ã†ï¼ˆæ€¥è¡Œï¼‰","å¿«è»Š",[], "L5"),
      toObj("ã¨ã£ãã‚…ã†ï¼ˆç‰¹æ€¥ï¼‰","ç‰¹å¿«è»Š",[], "L5"),
    ];

    // L6
    const L6 = [
      toObj("ãŸã¹ã¾ã™ï¼ˆé£Ÿã¹ã¾ã™ï¼‰","åƒ",[], "L6"),
      toObj("ã®ã¿ã¾ã™ï¼ˆé£²ã¿ã¾ã™ï¼‰","å–",[], "L6"),
      toObj("ã™ã„ã¾ã™ï¼ˆå¸ã„ã¾ã™ï¼‰","å¸",[], "L6"),
      toObj("ã¿ã¾ã™ï¼ˆè¦‹ã¾ã™ï¼‰","çœ‹",[], "L6"),
      toObj("ããã¾ã™ï¼ˆèãã¾ã™ï¼‰","è½",[], "L6"),
      toObj("ã‚ˆã¿ã¾ã™ï¼ˆèª­ã¿ã¾ã™ï¼‰","é–±è®€",[], "L6"),
      toObj("ã‹ãã¾ã™ï¼ˆæ›¸ãã¾ã™ï¼‰","æ›¸å¯«",[], "L6"),
      toObj("ã‹ã„ã¾ã™ï¼ˆè²·ã„ã¾ã™ï¼‰","è³¼è²·",[], "L6"),
      toObj("ã¨ã‚Šã¾ã™ï¼ˆæ’®ã‚Šã¾ã™ï¼‰","æ‹æ”ã€”ç…§ç‰‡ã€•",[], "L6"),
      toObj("ã—ã¾ã™","åš",[], "L6"),
      toObj("ã‚ã„ã¾ã™ï¼ˆä¼šã„ã¾ã™ï¼‰","ã€”è·Ÿæœ‹å‹ã€•è¦‹é¢",[], "L6"),
      toObj("ã”ã¯ã‚“","ç™½é£¯ã€é£¯",[], "L6"),
      toObj("ã‚ã•ã”ã¯ã‚“ï¼ˆæœã”ã¯ã‚“ï¼‰","æ—©é¤",[], "L6"),
      toObj("ã²ã‚‹ã”ã¯ã‚“ï¼ˆæ˜¼ã”ã¯ã‚“ï¼‰","åˆé¤",[], "L6"),
      toObj("ã°ã‚“ã”ã¯ã‚“ï¼ˆæ™©ã”ã¯ã‚“ï¼‰","æ™šé¤",[], "L6"),
      toObj("ãƒ‘ãƒ³","éºµåŒ…",[], "L6"),
      toObj("ãŸã¾ã”ï¼ˆåµï¼‰","è›‹",[], "L6"),
      toObj("ã«ãï¼ˆè‚‰ï¼‰","è‚‰",[], "L6"),
      toObj("ã•ã‹ãªï¼ˆé­šï¼‰","é­š",[], "L6"),
      toObj("ã‚„ã•ã„ï¼ˆé‡èœï¼‰","è”¬èœ",[], "L6"),
      toObj("ãã ã‚‚ã®ï¼ˆæœç‰©ï¼‰","æ°´æœ",[], "L6"),
      toObj("ã¿ãšï¼ˆæ°´ï¼‰","æ°´",[], "L6"),
      toObj("ãŠã¡ã‚ƒï¼ˆãŠèŒ¶ï¼‰","èŒ¶",[], "L6"),
      toObj("ã“ã†ã¡ã‚ƒï¼ˆç´…èŒ¶ï¼‰","ç´…èŒ¶",[], "L6"),
      toObj("ãã‚…ã†ã«ã‚…ã†ï¼ˆç‰›ä¹³ï¼‰","ç‰›å¥¶",[], "L6"),
      toObj("ã‚¸ãƒ¥ãƒ¼ã‚¹","æœæ±",[], "L6"),
      toObj("ãƒ“ãƒ¼ãƒ«","å•¤é…’",[], "L6"),
      toObj("[ãŠ]ã•ã‘ï¼ˆ[ãŠ]é…’ï¼‰","é…’é¡ã€æ—¥æœ¬é…’",[], "L6"),
      toObj("ãŸã°ã“","é¦™è¸",[], "L6"),
      toObj("ã¦ãŒã¿ï¼ˆæ‰‹ç´™ï¼‰","ä¿¡",[], "L6"),
      toObj("ãƒ¬ãƒãƒ¼ãƒˆ","å ±å‘Š",[], "L6"),
      toObj("ã—ã‚ƒã—ã‚“ï¼ˆå†™çœŸï¼‰","ç…§ç‰‡",[], "L6"),
      toObj("ãƒ“ãƒ‡ã‚ª","å½±ç‰‡ã€éŒ„å½±å¸¶",[], "L6"),
      toObj("ã¿ã›ï¼ˆåº—ï¼‰","å•†åº—",[], "L6"),
      toObj("ã«ã‚ï¼ˆåº­ï¼‰","åº­é™¢ã€é™¢å­",[], "L6"),
      toObj("ã—ã‚…ãã ã„ï¼ˆå®¿é¡Œï¼‰","ä½œæ¥­",[], "L6"),
      toObj("ãƒ†ãƒ‹ã‚¹","ç¶²çƒ",[], "L6"),
      toObj("ã‚µãƒƒã‚«ãƒ¼","è¶³çƒ",[], "L6"),
      toObj("[ãŠ]ã¯ãªã¿ï¼ˆ[ãŠ]èŠ±è¦‹ï¼‰","è³èŠ±",[], "L6"),
      toObj("ãªã«ï¼ˆä½•ï¼‰","ä»€éº¼",[], "L6"),
      toObj("ã„ã£ã—ã‚‡ã«","ä¸€èµ·",[], "L6"),
      toObj("ã¡ã‚‡ã£ã¨","ä¸€æœƒã€ä¸€é»",[], "L6"),
      toObj("ã„ã¤ã‚‚","ç¶“å¸¸ã€ç¸½æ˜¯",[], "L6"),
      toObj("ã¨ãã©ã","æœ‰æ™‚",[], "L6"),
      toObj("ãã‚Œã‹ã‚‰","ç„¶å¾Œ",[], "L6"),
      toObj("ãˆãˆ","æ˜¯çš„",[], "L6"),
      toObj("ã„ã„ã§ã™ã­ã€‚","å¥½å•Šã€‚",[], "L6"),
      toObj("ã‚ã‹ã‚Šã¾ã—ãŸã€‚","æˆ‘æ˜ç™½äº†ã€‚",[], "L6"),
      toObj("ãªã‚“ã§ã™ã‹ã€‚ï¼ˆä½•ã§ã™ã‹ã€‚ï¼‰","ä»€éº¼äº‹?",[], "L6"),
      toObj("ã˜ã‚ƒã€ã¾ãŸ[ã‚ã—ãŸ]ã€‚","é‚£éº¼,ã€”æ˜å¤©ã€•å†è¦‹ã€‚",[], "L6"),
    ];

    // L7
    const L7 = [
      toObj("ãã‚Šã¾ã™ï¼ˆåˆ‡ã‚Šã¾ã™ï¼‰","åˆ‡ã€å‰ª",[], "L7"),
      toObj("ãŠãã‚Šã¾ã™ï¼ˆé€ã‚Šã¾ã™ï¼‰","å¯„ã€é€",[], "L7"),
      toObj("ã‚ã’ã¾ã™","çµ¦",[], "L7"),
      toObj("ã‚‚ã‚‰ã„ã¾ã™","å¾—åˆ°",[], "L7"),
      toObj("ã‹ã—ã¾ã™ï¼ˆè²¸ã—ã¾ã™ï¼‰","å€Ÿçµ¦",[], "L7"),
      toObj("ã‹ã‚Šã¾ã™ï¼ˆå€Ÿã‚Šã¾ã™ï¼‰","å€Ÿ",[], "L7"),
      toObj("ãŠã—ãˆã¾ã™ï¼ˆæ•™ãˆã¾ã™ï¼‰","æ•™ã€å‘Šè¨´",[], "L7"),
      toObj("ãªã‚‰ã„ã¾ã™ï¼ˆç¿’ã„ã¾ã™ï¼‰","å­¸ç¿’",[], "L7"),
      toObj("ã‹ã‘ã¾ã™","æ‰“[é›»è©±]",[], "L7"),
      toObj("ã¦ï¼ˆæ‰‹ï¼‰","æ‰‹",[], "L7"),
      toObj("ã¯ã—","ç­·å­",[], "L7"),
      toObj("ã‚¹ãƒ—ãƒ¼ãƒ³","æ¹¯åŒ™",[], "L7"),
      toObj("ãƒŠã‚¤ãƒ•","åˆ€å­",[], "L7"),
      toObj("ãƒ•ã‚©ãƒ¼ã‚¯","å‰å­",[], "L7"),
      toObj("ã¯ã•ã¿","å‰ªåˆ€",[], "L7"),
      toObj("ãƒ‘ã‚½ã‚³ãƒ³","å€‹äººé›»è…¦",[], "L7"),
      toObj("ã‚±ãƒ¼ã‚¿ã‚¤","æ‰‹æ©Ÿ",[], "L7"),
      toObj("ãƒ¡ãƒ¼ãƒ«","é›»å­éƒµä»¶",[], "L7"),
      toObj("ã­ã‚“ãŒã˜ã‚‡ã†ï¼ˆå¹´è³€çŠ¶ï¼‰","è³€å¹´å¡",[], "L7"),
      toObj("ãƒ‘ãƒ³ãƒ","æ‰“æ´æ©Ÿ",[], "L7"),
      toObj("ãƒ›ãƒƒãƒã‚­ã‚¹","é‡˜æ›¸æ©Ÿ",[], "L7"),
      toObj("ã‚»ãƒ­ãƒ†ãƒ¼ãƒ—","é€æ˜è† å¸¶",[], "L7"),
      toObj("ã‘ã—ã‚´ãƒ ï¼ˆæ¶ˆã—ã‚´ãƒ ï¼‰","æ©¡çš®æ“¦",[], "L7"),
      toObj("ã‹ã¿ï¼ˆç´™ï¼‰","ç´™",[], "L7"),
      toObj("ã¯ãªï¼ˆèŠ±ï¼‰","èŠ±",[], "L7"),
      toObj("ã‚·ãƒ£ãƒ„","è¥¯è¡«",[], "L7"),
      toObj("ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ","ç¦®ç‰©",[], "L7"),
      toObj("ã«ã‚‚ã¤ï¼ˆè·ç‰©ï¼‰","è¡Œæã€åŒ…è£¹",[], "L7"),
      toObj("ãŠã‹ã­ï¼ˆãŠé‡‘ï¼‰","éŒ¢",[], "L7"),
      toObj("ãã£ã·ï¼ˆåˆ‡ç¬¦ï¼‰","è»Šç¥¨ã€å…¥å ´åˆ¸",[], "L7"),
      toObj("ã‚¯ãƒªã‚¹ãƒã‚¹","è–èª•ç¯€",[], "L7"),
      toObj("ã¡ã¡ï¼ˆçˆ¶ï¼‰","å®¶çˆ¶",[], "L7"),
      toObj("ã¯ã¯ï¼ˆæ¯ï¼‰","å®¶æ¯",[], "L7"),
      toObj("ãŠã¨ã†ã•ã‚“ï¼ˆãŠçˆ¶ã•ã‚“ï¼‰","ï¼ˆåˆ¥äººçš„/ç¨±å‘¼è‡ªå·±çš„ï¼‰çˆ¶è¦ª",[], "L7"),
      toObj("ãŠã‹ã‚ã•ã‚“ï¼ˆãŠæ¯ã•ã‚“ï¼‰","ï¼ˆåˆ¥äººçš„/ç¨±å‘¼è‡ªå·±çš„ï¼‰æ¯è¦ª",[], "L7"),
      toObj("ã‚‚ã†","å·²ç¶“",[], "L7"),
      toObj("ã¾ã ","å°šæœªã€é‚„æ²’",[], "L7"),
      toObj("ã“ã‚Œã‹ã‚‰","å¾ç¾åœ¨èµ·ï¼ˆè¦å»åšæŸäº‹ï¼‰",[], "L7"),
      toObj("ã„ã‚‰ã£ã—ã‚ƒã„ã€‚","æ­¡è¿ã€‚",[], "L7"),
      toObj("ã©ã†ããŠã‚ãŒã‚Šãã ã•ã„ã€‚ï¼ˆã©ã†ããŠä¸ŠãŒã‚Šãã ã•ã„ã€‚ï¼‰","è«‹é€²ã€‚",[], "L7"),
      toObj("ã—ã¤ã‚Œã„ã—ã¾ã™ã€‚ï¼ˆå¤±ç¤¼ã—ã¾ã™ã€‚ï¼‰","æ‰“æ“¾äº†ã€‚",[], "L7"),
      toObj("[ã€œã¯]ã„ã‹ãŒã§ã™ã‹ã€‚","ä½ è¦ºå¾—ã€”ã€œã€•æ€éº¼æ¨£?",[], "L7"),
      toObj("ã„ãŸã ãã¾ã™ã€‚","æˆ‘é–‹å‹•äº†ã€‚",[], "L7"),
      toObj("ã”ã¡ãã†ã•ã¾[ã§ã—ãŸ]ã€‚","æˆ‘åƒé£½äº†ï¼è¬è¬æ‹›å¾…ã€‚",[], "L7"),
      toObj("ã€Œã€œã€ã€ã™ã¦ãã§ã™ã­ã€‚","ã€”ã€œ,ã€•çœŸä¸éŒ¯å•Š!",[], "L7"),
    ];

    // L8
    const L8 = [
      toObj("ãƒãƒ³ã‚µãƒ ","è‹±ä¿Š",[], "L8"),
      toObj("ãã‚Œã„","æ¼‚äº®",[], "L8"),
      toObj("ã—ãšã‹ï¼ˆé™ã‹[ãª]ï¼‰","å®‰éœ",[], "L8"),
      toObj("ã«ãã‚„ã‹","ç†±é¬§",[], "L8"),
      toObj("ã‚†ã†ã‚ã„ï¼ˆæœ‰å[ãª]ï¼‰","æœ‰å",[], "L8"),
      toObj("ã—ã‚“ã›ã¤ï¼ˆè¦ªåˆ‡[ãª]ï¼‰","è¦ªåˆ‡ï¼ˆä¸ç”¨æ–¼è‡ªå·±çš„è¦ªå±¬ï¼‰",[], "L8"),
      toObj("ã’ã‚“ãï¼ˆå…ƒæ°—[ãª]ï¼‰","å¥åº·",[], "L8"),
      toObj("ã²ã¾ï¼ˆæš‡[ãª]ï¼‰","æœ‰æ™‚é–“ã€æœ‰ç©º",[], "L8"),
      toObj("ã¹ã‚“ã‚Šï¼ˆä¾¿åˆ©[ãª]ï¼‰","æ–¹ä¾¿",[], "L8"),
      toObj("ã™ã¦ã","éå¸¸å¥½",[], "L8"),
      toObj("ãŠãŠãã„ï¼ˆå¤§ãã„ï¼‰","å¤§",[], "L8"),
      toObj("ã¡ã„ã•ã„ï¼ˆå°ã•ã„ï¼‰","å°",[], "L8"),
      toObj("ã‚ãŸã‚‰ã—ã„ï¼ˆæ–°ã—ã„ï¼‰","æ–°ã€æ–°é®®",[], "L8"),
      toObj("ãµã‚‹ã„ï¼ˆå¤ã„ï¼‰","èˆŠã€ä¸æ–°é®®",[], "L8"),
      toObj("ã„ã„ï¼ˆè‰¯ã„ï¼‰","å¥½",[], "L8"),
      toObj("ã‚ã‚‹ã„ï¼ˆæ‚ªã„ï¼‰","å£",[], "L8"),
      toObj("ã‚ã¤ã„ï¼ˆæš‘ã„ã€ç†±ã„ï¼‰","ç†±",[], "L8"),
      toObj("ã•ã‚€ã„ï¼ˆå¯’ã„ï¼‰","å†·",[], "L8"),
      toObj("ã¤ã‚ãŸã„ï¼ˆå†·ãŸã„ï¼‰","å†°ã€æ¶¼",[], "L8"),
      toObj("ã‚€ãšã‹ã—ã„ï¼ˆé›£ã—ã„ï¼‰","é›£",[], "L8"),
      toObj("ã‚„ã•ã—ã„ï¼ˆæ˜“ã—ã„ï¼‰","ç°¡å–®",[], "L8"),
      toObj("ãŸã‹ã„ï¼ˆé«˜ã„ï¼‰","è²´ã€é«˜",[], "L8"),
      toObj("ã‚„ã™ã„ï¼ˆå®‰ã„ï¼‰","ä¾¿å®œ",[], "L8"),
      toObj("ã²ãã„ï¼ˆä½ã„ï¼‰","ä½ã€çŸ®",[], "L8"),
      toObj("ãŠã‚‚ã—ã‚ã„","æœ‰è¶£",[], "L8"),
      toObj("ãŠã„ã—ã„","å¥½åƒ",[], "L8"),
      toObj("ã„ããŒã—ã„ï¼ˆå¿™ã—ã„ï¼‰","å¿™",[], "L8"),
      toObj("ãŸã®ã—ã„ï¼ˆæ¥½ã—ã„ï¼‰","æ„‰å¿«ã€é«˜èˆˆ",[], "L8"),
      toObj("ã—ã‚ã„ï¼ˆç™½ã„ï¼‰","ç™½è‰²",[], "L8"),
      toObj("ãã‚ã„ï¼ˆé»’ã„ï¼‰","é»‘è‰²",[], "L8"),
      toObj("ã‚ã‹ã„ï¼ˆèµ¤ã„ï¼‰","ç´…è‰²",[], "L8"),
      toObj("ã‚ãŠã„ï¼ˆé’ã„ï¼‰","è—è‰²",[], "L8"),
      toObj("ã•ãã‚‰ï¼ˆæ¡œï¼‰","æ«»èŠ±",[], "L8"),
      toObj("ã‚„ã¾ï¼ˆå±±ï¼‰","å±±",[], "L8"),
      toObj("ã¾ã¡ï¼ˆç”ºï¼‰","å¸‚é®ã€è¡—é“",[], "L8"),
      toObj("ãŸã¹ã‚‚ã®ï¼ˆé£Ÿã¹ç‰©ï¼‰","é£Ÿç‰©",[], "L8"),
      toObj("ã¨ã“ã‚ï¼ˆæ‰€ï¼‰","åœ°æ–¹",[], "L8"),
      toObj("ã‚Šã‚‡ã†ï¼ˆå¯®ï¼‰","å®¿èˆ",[], "L8"),
      toObj("ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³","é¤å»³",[], "L8"),
      toObj("ã›ã„ã‹ã¤ï¼ˆç”Ÿæ´»ï¼‰","ç”Ÿæ´»",[], "L8"),
      toObj("[ãŠ]ã—ã”ã¨ï¼ˆ[ãŠ] ä»•äº‹ï¼‰","å·¥ä½œï¼ˆã€œã‚’ã—ã¾ã™: å·¥ä½œï¼‰",[], "L8"),
      toObj("ã©ã†","æ€éº¼æ¨£",[], "L8"),
      toObj("ã©ã‚“ãª","ä»€éº¼æ¨£çš„ã€œ",[], "L8"),
      toObj("ã¨ã¦ã‚‚","éå¸¸",[], "L8"),
      toObj("ã‚ã¾ã‚Š","ä¸å¤ªã€œï¼ˆç”¨æ–¼å¦å®šå¥ï¼‰",[], "L8"),
      toObj("ãã—ã¦","æ–¼æ˜¯ï¼ˆé€£æ¥å¥å­ï¼‰",[], "L8"),
      toObj("ã€œãŒã€ã€œ","~ä½†æ˜¯ã€œ",[], "L8"),
    ];

    const ALL = [...L5, ...L6, ...L7, ...L8];

    // ---------- ç‹€æ…‹ ----------
    let mode = "jp2zh";
    let pool = [];
    let totalQ = 10;
    let qIndex = 0;
    let score = 0;
    let streak = 0, bestStreak = 0;
    let timed = false;
    let timeLeft = 60;
    let timerId = null;
    let wrongSet = [];
    let askedIds = new Set();
    let starSet = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY_STARS)||"[]"));

    // ---------- DOM åˆå§‹åŒ– ----------
    function renderBankAll(){
      renderBank($("#bankL5"), L5);
      renderBank($("#bankL6"), L6);
      renderBank($("#bankL7"), L7);
      renderBank($("#bankL8"), L8);
    }
    function renderBank(target, data){
      const katakanaOn = $("#katakana").checked;
      const showKanji = $("#showKanji").checked;
      target.innerHTML = "";
      data.forEach(w=>{
        const d = document.createElement("div");
        d.className = "item";
        const left = document.createElement("div");
        left.innerHTML = `<div style="font-weight:900">${displayJP(w, showKanji, katakanaOn)}</div><div>${w.zh}</div><div class="pill">${w.l}</div>`;
        const btn = document.createElement("button");
        btn.className = "starbtn";
        btn.innerHTML = starSet.has(w.id) ? "â­ï¸" : "â˜†";
        if(starSet.has(w.id)) btn.classList.add("star-on");
        btn.onclick = ()=>{ toggleStar(w.id); btn.innerHTML = starSet.has(w.id) ? "â­ï¸" : "â˜†"; btn.classList.toggle("star-on", starSet.has(w.id)); };
        d.appendChild(left); d.appendChild(btn);
        target.appendChild(d);
      });
    }
    function toggleStar(id){
      if(starSet.has(id)) starSet.delete(id); else starSet.add(id);
      localStorage.setItem(STORAGE_KEY_STARS, JSON.stringify([...starSet]));
    }
    renderBankAll();

    // ---------- åå¥½è¨˜æ†¶ ----------
    function savePrefs(){
      const prefs = {
        useL5: $("#useL5").checked, useL6: $("#useL6").checked, useL7: $("#useL7").checked, useL8: $("#useL8").checked,
        tagSuffix: $("#tagSuffix").checked, tagCountry: $("#tagCountry").checked, tagTime: $("#tagTime").checked,
        onlyStar: $("#onlyStar").checked, timed: $("#timed").checked, byLesson: $("#byLesson").checked,
        katakana: $("#katakana").checked, showKanji: $("#showKanji").checked, totalQ, mode
      };
      localStorage.setItem(STORAGE_KEY_PREFS, JSON.stringify(prefs));
    }
    function loadPrefs(){
      const raw = localStorage.getItem(STORAGE_KEY_PREFS);
      if(!raw) return;
      try{
        const p = JSON.parse(raw);
        ["useL5","useL6","useL7","useL8","tagSuffix","tagCountry","tagTime","onlyStar","timed","byLesson","katakana","showKanji"].forEach(k=>{
          if(typeof p[k] === "boolean"){ $("#"+k).checked = p[k]; }
        });
        if(p.totalQ){ totalQ = p.totalQ; $("#qcount").textContent = "ç›®å‰ï¼š" + totalQ + " é¡Œ"; }
        if(p.mode){ const m = p.mode; const el = document.querySelector(`input[name="mode"][value="${m}"]`); if(el){ el.checked = true; mode=m; } }
      }catch(e){}
    }
    loadPrefs();

    // é¡Œæ•¸æŒ‰éˆ•
    document.querySelectorAll('[data-q]').forEach(btn=>{
      btn.addEventListener('click',()=>{ totalQ = parseInt(btn.dataset.q,10); $("#qcount").textContent = "ç›®å‰ï¼š" + totalQ + " é¡Œ"; savePrefs(); });
    });

    // äº’å‹•æŒ‰éˆ•
    $("#startBtn").addEventListener("click", startQuiz);
    $("#speakBtn").addEventListener("click", speakPrompt);
    $("#restart").addEventListener("click", ()=>{
      $("#summary").style.display="none"; $("#setup").style.display="block";
    });
    $("#retryWrong").addEventListener("click", retryWrongOnly);

    // å–®é¸æ¨¡å¼å³æ™‚å­˜
    document.querySelectorAll('input[name="mode"]').forEach(r=>{
      r.addEventListener("change", ()=>{ mode = r.value; savePrefs(); });
    });
    // å…¶ä»–è¨­å®šå³æ™‚å­˜ï¼‹å³æ™‚å½±éŸ¿æ¸…å–®é¡¯ç¤º
    ["useL5","useL6","useL7","useL8","tagSuffix","tagCountry","tagTime","onlyStar","timed","byLesson","katakana","showKanji"].forEach(id=>{
      $("#"+id).addEventListener("change", ()=>{
        savePrefs();
        if(id==="katakana" || id==="showKanji"){ renderBankAll(); }
      });
    });

    // ---------- æ± èˆ‡æŠ½é¡Œ ----------
    function buildPool(){
      const use5 = $("#useL5").checked;
      const use6 = $("#useL6").checked;
      const use7 = $("#useL7").checked;
      const use8 = $("#useL8").checked;
      const wantSuffix = $("#tagSuffix").checked;
      const wantCountry = $("#tagCountry").checked;
      const wantTime = $("#tagTime").checked;
      const onlyStar = $("#onlyStar").checked;

      let p = ALL.filter(w => (w.l==="L5" && use5) || (w.l==="L6" && use6) || (w.l==="L7" && use7) || (w.l==="L8" && use8));
      if(wantSuffix || wantCountry || wantTime){
        p = p.filter(w => {
          const hasS = w.tags.includes(T.SUFFIX);
          const hasC = w.tags.includes(T.COUNTRY);
          const hasT = w.tags.includes(T.TIME);
          return (wantSuffix&&hasS) || (wantCountry&&hasC) || (wantTime&&hasT);
        });
      }
      if(onlyStar){ p = p.filter(w=> starSet.has(w.id)); }
      const byLesson = $("#byLesson").checked;
      if(byLesson){
        const order = ["L5","L6","L7","L8"];
        p.sort((a,b)=> order.indexOf(a.l) - order.indexOf(b.l));
      }else{
        shuffle(p);
      }
      return p;
    }

    // ---------- è¨ˆæ™‚ ----------
    function startTimer(){
      if(!timed){ return; }
      clearInterval(timerId);
      $("#timeChip").style.display = "inline-block";
      $("#timeLeft").textContent = timeLeft;
      timerId = setInterval(()=>{
        timeLeft--;
        $("#timeLeft").textContent = timeLeft;
        if(timeLeft<=0){ clearInterval(timerId); endQuiz(true); }
      }, 1000);
    }
    function addBonusSeconds(n=3){
      if(!timed) return;
      timeLeft = Math.min(timeLeft + n, 999);
      $("#timeLeft").textContent = timeLeft;
      const t = document.createElement("span"); t.textContent = `+${n}s`; t.style.marginLeft="6px"; t.style.color="var(--ok)"; t.style.fontWeight="900";
      const chip = $("#timeChip"); chip.appendChild(t); setTimeout(()=>t.remove(), 600);
    }

    // ---------- é€²å…¥æ¸¬é©— ----------
    function startQuiz(){
      mode = document.querySelector('input[name="mode"]:checked').value;
      pool = buildPool();
      if(pool.length < 3){ alert("é¡Œåº«éå°ï¼šè«‹èª¿æ•´ç¯„åœæˆ–å–æ¶ˆéåº¦çš„æ¨™ç±¤/æ˜Ÿè™Ÿç¯©é¸ã€‚"); return; }
      timed = $("#timed").checked;
      timeLeft = 60;
      qIndex=0; score=0; streak=0; bestStreak=0; wrongSet = []; askedIds.clear();
      $("#score").textContent = "0"; $("#streak").textContent = "0";
      $("#setup").style.display="none";
      $("#quiz").style.display="block";
      $("#summary").style.display="none";
      $("#modeTag").textContent = mode==="jp2zh"?"JPâ†’ZH":(mode==="zh2jp"?"ZHâ†’JP":"æ¼¢å­—â†’å‡å");
      startTimer();
      nextQuestion();
    }

    // ---------- å‡ºé¡Œï¼ˆä¸é‡è¤‡ï¼‰ ----------
    function pickNext(){
      const remain = pool.filter(w=>!askedIds.has(w.id));
      if(remain.length===0) return null;
      return remain[Math.floor(Math.random()*remain.length)];
    }

    function nextQuestion(){
      $("#resultBox").style.display="none";
      $("#nextBtn").disabled = true;
      if(qIndex >= totalQ){ endQuiz(); return; }
      $("#meta").textContent = `ç¬¬ ${qIndex+1} / ${totalQ} é¡Œ`;
      $("#bar").style.width = ((qIndex)/totalQ)*100 + "%";

      const q = pickNext();
      if(!q){ endQuiz(); return; }
      askedIds.add(q.id);

      const starBtnHTML = `<button class="starbtn ${starSet.has(q.id)?'star-on':''}" id="starQBtn" title="åŠ æ˜Ÿ">${starSet.has(q.id)?'â­ï¸':'â˜†'}</button>`;

      const katakanaOn = $("#katakana").checked;
      const showKanji = $("#showKanji").checked;

      let opts;
      if(mode==="kanji2kana"){
        // è®€éŸ³æ¨¡å¼ï¼šå›ºå®šå‡ºã€Œæ¼¢å­—ã€â†’ å‡å
        const prompt = q.kanji || q.jp;
        const distractors = sampleUnique(ALL.filter(w=> w.kana!==q.kana), 2);
        opts = shuffle([q, ...distractors]);
        $("#qtext").innerHTML = prompt + " " + starBtnHTML;
        const texts = opts.map(o=> katakanaOn ? hira2kata(o.kana) : o.kana);
        renderChoices(texts, (katakanaOn ? hira2kata(q.kana) : q.kana), q, ["A","B","C"]);
        $("#choices").dataset.prompt = katakanaOn ? hira2kata(q.kana) : q.kana;
      } else if(mode==="jp2zh"){
        // é¡Œç›®é¡¯ç¤ºæ—¥æ–‡ï¼ˆä¾æ¼¢å­—/ç‰‡å‡åè¨­å®šï¼‰ï¼Œé¸é …æ˜¯ä¸­æ–‡
        const distractors = sampleUnique(ALL.filter(w=> w.zh!==q.zh), 2);
        opts = shuffle([q, ...distractors]);
        $("#qtext").innerHTML = displayJP(q, showKanji, katakanaOn) + " " + starBtnHTML;
        renderChoices(opts.map(o=>o.zh), q.zh, q, ["A","B","C"]);
        $("#choices").dataset.prompt = q.kana; // æœ—è®€ç”¨å‡å
      } else {
        // çœ‹åˆ°ä¸­æ–‡ â†’ é¸æ—¥æ–‡ï¼ˆé¸é …ä¾æ¼¢å­—/ç‰‡å‡åè¨­å®šï¼‰
        const distractors = sampleUnique(ALL.filter(w=> w.jp!==q.jp), 2);
        opts = shuffle([q, ...distractors]);
        $("#qtext").innerHTML = q.zh + " " + starBtnHTML;
        const showTexts = opts.map(o=> displayJP(o, showKanji, katakanaOn));
        const correctShow = displayJP(q, showKanji, katakanaOn);
        renderChoices(showTexts, correctShow, q, ["A","B","C"]);
        $("#choices").dataset.prompt = q.kana; // æœ—è®€ç”¨å‡å
      }

      const starBtn = $("#starQBtn");
      starBtn.onclick = ()=>{ toggleStar(q.id); starBtn.textContent = starSet.has(q.id) ? "â­ï¸" : "â˜†"; starBtn.classList.toggle("star-on", starSet.has(q.id)); };

      $("#nextBtn").onclick = ()=>{ qIndex++; nextQuestion(); };
    }

    function renderChoices(texts, correctText, qobj, labels){
      const choices = $("#choices"); choices.innerHTML="";
      texts.forEach((txt, idx)=>{
        const div = document.createElement("div");
        div.className="choice";
        div.setAttribute("role","button");
        div.innerHTML = `<div class="key">${labels[idx]||String.fromCharCode(65+idx)}</div><div class="text">${txt}</div>`;
        div.addEventListener("click", ()=>onChoose(txt, correctText, qobj));
        choices.appendChild(div);
      });
      // éµç›¤å¿«æ·
      const keyMap = {a:0,b:1,c:2};
      document.onkeydown = (e)=>{
        if($("#quiz").style.display==="none") return;
        const k = e.key.toLowerCase();
        if(k===" "){ e.preventDefault(); speakPrompt(); }
        else if(k==="enter"){
          e.preventDefault();
          if(!$("#nextBtn").disabled){ $("#nextBtn").click(); }
        }else if(k in keyMap){
          const i = keyMap[k];
          const el = choices.children[i];
          if(el) el.click();
        }
      };
    }

    function onChoose(chosenText, correctText, q){
      const ok = (chosenText === correctText);
      const box = $("#resultBox");
      const head = $("#resHead");
      const body = $("#resBody");
      if(ok){
        score++; streak++; bestStreak = Math.max(bestStreak, streak);
        $("#score").textContent = score; $("#streak").textContent = streak;
        box.classList.remove("bad"); box.classList.add("ok");
        head.textContent = "âœ… æ­£ç¢ºï¼";
        if(timed) addBonusSeconds(3);
      }else{
        streak=0; $("#streak").textContent = streak;
        box.classList.remove("ok"); box.classList.add("bad");
        head.textContent = "âŒ ç­”éŒ¯äº†";
        wrongSet.push(q);
      }

      const katakanaOn = $("#katakana").checked;
      const showKanji = $("#showKanji").checked;

      if(mode==="kanji2kana"){
        const showKana = katakanaOn ? hira2kata(q.kana) : q.kana;
        body.textContent = `${q.kanji} â†’ ${showKana}ï½œ${q.zh}`;
      }else if(mode==="jp2zh"){
        body.textContent = `${displayJP(q, showKanji, katakanaOn)} â†’ ${q.zh}`;
      }else{
        body.textContent = `${q.zh} â†’ ${displayJP(q, showKanji, katakanaOn)}`;
      }
      box.style.display="block";
      $("#nextBtn").disabled = false;
    }

    function endQuiz(timeUp=false){
      clearInterval(timerId); timerId=null;
      $("#quiz").style.display="none";
      $("#summary").style.display="block";
      $("#finalScore").textContent = score;
      $("#finalTotal").textContent = totalQ;
      $("#finalStreak").textContent = bestStreak;
      $("#bar").style.width = "100%";
      $("#timeChip").style.display = "none";
      const btn = $("#retryWrong");
      btn.disabled = wrongSet.length===0;
      if(timeUp){ alert("æ™‚é–“åˆ°ï¼çœ‹çœ‹é€™å›åˆæˆç¸¾ï½"); }
      document.onkeydown = null;
    }

    function retryWrongOnly(){
      if(wrongSet.length===0){ alert("æ²’æœ‰éŒ¯é¡Œå¯é‡ç·´ï¼"); return; }
      const map = new Map(); wrongSet.forEach(w=>map.set(w.id,w));
      pool = [...map.values()];
      timed = false;
      qIndex=0; score=0; streak=0; bestStreak=0;
      askedIds.clear();
      $("#score").textContent = "0";
      $("#streak").textContent = "0";
      $("#summary").style.display="none";
      $("#quiz").style.display="block";
      $("#modeTag").textContent = mode==="jp2zh"?"JPâ†’ZH":(mode==="zh2jp"?"ZHâ†’JP":"æ¼¢å­—â†’å‡å");
      nextQuestion();
    }

    function speakPrompt(){
      const text = $("#choices").dataset.prompt || "";
      if(!text) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "ja-JP";
      speechSynthesis.stop();
      speechSynthesis.speak(utter);
    }
  </script>
</body>
</html>

</html>
