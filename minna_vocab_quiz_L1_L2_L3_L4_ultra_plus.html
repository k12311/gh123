<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>å¤§å®¶çš„æ—¥æœ¬èª N5ï½œå–®å­—å°è€ƒï¼ˆL1â€“L4 æ‰‹å¯«ç‰ˆï¼‰</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <style>
    :root{ --bg1:#fff6dc; --bg2:#ffeec5; --paper:#fff7da; --ink:#1d1608; --accent:#d9983d; --accent-d:#b67a2f; --ok:#2e7d32; --bad:#c62828; --shadow:0 10px 20px rgba(0,0,0,.08); }
    html,body{height:100%}
    body{margin:0;font-family: ui-rounded,"SF Pro Rounded",-apple-system,system-ui,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif;color:var(--ink);
      background: radial-gradient(120% 120% at 0% 0%, var(--bg1), var(--bg2)); background-attachment:fixed; -webkit-tap-highlight-color: transparent;}
    .app{min-height:100dvh;display:flex;flex-direction:column}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 14px;background:color-mix(in oklab,#fff 70%,transparent);backdrop-filter: blur(6px);border-bottom:1px dashed rgba(0,0,0,.08)}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:14px;background:var(--paper);display:grid;place-items:center;font-weight:900;color:var(--accent);box-shadow:inset 0 0 0 2px rgba(0,0,0,.06)}
    .title{font-weight:900;color:var(--accent)}
    .hud{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .chip{background:var(--paper);padding:6px 10px;border-radius:999px;font-weight:900;box-shadow:var(--shadow)}
    main{flex:1;padding:14px;display:flex}
    .card{margin:auto;width:min(1000px,100%);background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:18px;box-shadow:var(--shadow);padding:16px 14px}
    .section{display:flex;flex-direction:column;gap:12px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:900;box-shadow:0 6px 0 var(--accent-d)}
    .btn:active{transform:translateY(2px);box-shadow:0 4px 0 var(--accent-d)}
    .ghost{background:#fff;color:var(--accent);box-shadow: inset 0 0 0 2px var(--accent)}
    .pill{background:#fff;border:1px solid rgba(0,0,0,.08);padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800}
    .title2{font-weight:900;color:#5f430e}
    .qtext{display:flex;align-items:center;gap:10px;font-size:1.6rem;font-weight:900;line-height:1.6;word-break:keep-all}
    .starbtn{border:0;background:transparent;font-size:1.4rem;cursor:pointer}
    .star-on{color:#f4b400;filter:drop-shadow(0 1px 0 rgba(0,0,0,.2))}
    .choices{display:grid;grid-template-columns:1fr;gap:10px}
    .choice{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:14px 12px;font-size:1.1rem;font-weight:800;box-shadow:var(--shadow)}
    .choice:active{transform:scale(.99)}
    .key{min-width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:var(--paper);color:var(--accent);border:1px solid rgba(0,0,0,.06)}
    .result{margin-top:10px;padding:10px;border-radius:12px;border:2px dashed rgba(0,0,0,.12);display:none}
    .result.ok{border-color: color-mix(in oklab, var(--ok) 40%, transparent)}
    .result.bad{border-color: color-mix(in oklab, var(--bad) 40%, transparent)}
    footer{position:sticky;bottom:0;z-index:10;padding:8px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px;background:color-mix(in oklab,#fff 70%,transparent);backdrop-filter: blur(6px);border-top:1px dashed rgba(0,0,0,.08)}
    .meter{flex:1;display:flex;gap:10px;align-items:center}
    .progress{height:12px;background:#fff;border:1px solid rgba(0,0,0,.1);border-radius:999px;overflow:hidden;flex:1}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#d9983d,#f7c66d)}
    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:8px}
    .item{background:var(--paper);padding:10px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    /* Handwriting pad */
    .pad-wrap{background:var(--paper); border:1px dashed rgba(0,0,0,.12); border-radius:14px; padding:12px}
    .pad-toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    #pad{width:100%; aspect-ratio: 1.6/1; background:white; border-radius:12px; box-shadow:inset 0 0 0 1px rgba(0,0,0,.08)}
    .trace-badge{display:none;margin-left:8px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">âœï¸</div>
        <div class="title">å¤§å®¶çš„æ—¥æœ¬èª N5ï½œå–®å­—å°è€ƒï¼ˆL1â€“L4 æ‰‹å¯«ç‰ˆï¼‰</div>
      </div>
      <div class="hud">
        <div class="chip">åˆ†æ•¸ <span id="score">0</span></div>
        <div class="chip">é€£å° <span id="streak">0</span></div>
        <div class="chip" id="timeChip" style="display:none">â± <span id="timeLeft">60</span>s</div>
      </div>
    </header>

    <main>
      <section class="card section" id="setup">
        <div class="title2">é¸æ“‡æ¨¡å¼</div>
        <div class="grid">
          <label class="row"><input type="radio" name="mode" value="jp2zh"> <span class="pill">çœ‹åˆ°æ—¥æ–‡ â†’ é¸ä¸­æ–‡</span></label>
          <label class="row"><input type="radio" name="mode" value="zh2jp"> <span class="pill">çœ‹åˆ°ä¸­æ–‡ â†’ é¸æ—¥æ–‡</span></label>
          <label class="row"><input type="radio" name="mode" value="kanji2kana"> <span class="pill">è®€éŸ³æ¨¡å¼ï¼šæ¼¢å­— â†’ å‡å</span></label>
          <label class="row"><input type="radio" name="mode" value="handwrite" checked> <span class="pill">æ›¸å¯«æ¨¡å¼ï¼šæ¼¢å­— â†’ æ‰‹å¯«å‡å âœï¸</span></label>
        </div>

        <div class="title2">ç¯„åœ</div>
        <div class="row">
          <label class="pill"><input type="checkbox" id="l1" checked> L1</label>
          <label class="pill"><input type="checkbox" id="l2" checked> L2</label>
          <label class="pill"><input type="checkbox" id="l3" checked> L3</label>
          <label class="pill"><input type="checkbox" id="l4" checked> L4</label>
        </div>

        <div class="title2">æ¨™ç±¤ç¯©é¸</div>
        <div class="row">
          <label class="pill"><input type="checkbox" id="tagSuffix"> æ¥å°¾è©</label>
          <label class="pill"><input type="checkbox" id="tagCountry"> åœ‹å®¶</label>
          <label class="pill"><input type="checkbox" id="tagTime"> æ™‚é–“é¡</label>
          <span class="pill"><input type="checkbox" id="onlyStar"> åªå‡º â­ï¸ æ˜Ÿè™Ÿå–®å­—</span>
        </div>

        <div class="title2">é¡Œæ•¸ & é™æ™‚</div>
        <div class="row">
          <button class="pill" data-q="10">10 é¡Œ</button>
          <button class="pill" data-q="20">20 é¡Œ</button>
          <span id="qcount" class="pill">ç›®å‰ï¼š10 é¡Œ</span>
        </div>
        <div class="row">
          <label class="pill"><input type="checkbox" id="timed"> é™æ™‚æ¨¡å¼ï¼ˆ60 ç§’ï¼Œé€£å° +3 ç§’ï¼‰</label>
        </div>

        <details>
          <summary>é¡Œåº«ä¸€è¦½ï¼ˆå¯ç›´æ¥åŠ æ˜Ÿï¼‰</summary>
          <div class="title2" style="margin-top:6px">L1</div>
          <div class="list" id="bankL1"></div>
          <div class="title2" style="margin-top:10px">L2</div>
          <div class="list" id="bankL2"></div>
          <div class="title2" style="margin-top:10px">L3</div>
          <div class="list" id="bankL3"></div>
          <div class="title2" style="margin-top:10px">L4</div>
          <div class="list" id="bankL4"></div>
        </details>

        <div class="row"><button class="btn" id="startBtn">é–‹å§‹æ¸¬é©— â–¶</button></div>
      </section>

      <section class="card section" id="quiz" style="display:none">
        <div class="row">
          <span class="pill" id="meta">ç¬¬ 1 / 10 é¡Œ</span>
          <span class="pill" id="modeTag">æ‰‹å¯«</span>
          <span class="pill" id="traceBadge" class="trace-badge">æç´…ï¼š<b id="traceChar"></b></span>
        </div>
        <div class="qtext" id="qtext">å•é¡Œ</div>

        <div id="handwriteWrap" class="pad-wrap" style="display:none">
          <div class="pad-toolbar">
            <button class="ghost" id="padUndo">æ’¤éŠ·</button>
            <button class="ghost" id="padClear">æ¸…é™¤</button>
            <button class="ghost" id="padShowAnswer">çœ‹ç­”æ¡ˆ</button>
            <button class="ghost" id="padTrace">æç´…ï¼ˆé¡¯ç¤ºæ­£è§£ï¼‰</button>
          </div>
          <canvas id="pad"></canvas>
        </div>

        <div class="choices" id="choices"></div>

        <div class="result" id="resultBox">
          <div id="resHead" style="font-weight:900;margin-bottom:4px"></div>
          <div id="resBody"></div>
        </div>

        <div class="row" id="selfJudgeRow" style="display:none">
          <button class="btn" id="selfOk">æˆ‘å¯«å°äº† âœ…</button>
          <button class="ghost" id="selfBad">æˆ‘å¯«éŒ¯äº† âŒ</button>
        </div>

        <div class="row">
          <button class="btn" id="nextBtn" disabled>ä¸‹ä¸€é¡Œ â†’</button>
          <button class="ghost" id="speakBtn">æœ—è®€</button>
        </div>
      </section>

      <section class="card section" id="summary" style="display:none">
        <div class="title2">å®Œæˆï¼</div>
        <div>åˆ†æ•¸ï¼š<b id="finalScore">0</b> ï¼ é¡Œæ•¸ï¼š<b id="finalTotal">0</b></div>
        <div>æœ€ä½³é€£å°ï¼š<b id="finalStreak">0</b></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="retryWrong" disabled>éŒ¯é¡Œé‡ç·´ â–¶</button>
          <button class="ghost" id="restart">å›åˆ°è¨­å®šé </button>
        </div>
      </section>
    </main>

    <footer>
      <div class="meter">
        <span class="pill">é€²åº¦</span>
        <div class="progress"><div class="bar" id="bar"></div></div>
      </div>
    </footer>
  </div>

  <script>
    const T = { SUFFIX:"æ¥å°¾è©", COUNTRY:"åœ‹å®¶", TIME:"æ™‚é–“" };
    function parseKanjiKanaFlexible(jp){
      let m = jp.match(/^(.*)ï¼ˆ(.*)ï¼‰$/);
      if(m){ return {kana:m[1], kanji:m[2]} }
      m = jp.match(/^(.*)\((.*)\)$/);
      if(m){ return {kana:m[1], kanji:m[2]} }
      return {kana:jp, kanji:jp};
    }

    // --- Data (same as ULTRA+, shortened L1-L4 for brevity) ---
    const L1_RAW = [
      ["ã‚ãŸã—","æˆ‘",[]],["ã‚ãªãŸ","ä½ ã€æ‚¨",[]],["ã€œã•ã‚“","ã€œå…ˆç”Ÿã€ã€œå°å§ã€ã€œå¥³å£«ï¼ˆæ¥å°¾ï¼‰",[T.SUFFIX]],["ã€œã˜ã‚“","ã€œäººï¼ˆè¡¨ç¤ºåœ‹ç±çš„æ¥å°¾è©ï¼‰",[T.SUFFIX]],
      ["ã›ã‚“ã›ã„ï¼ˆå…ˆç”Ÿï¼‰","è€å¸«",[]],["ãŒãã›ã„ï¼ˆå­¦ç”Ÿï¼‰","å­¸ç”Ÿ",[]],["ã‚¢ãƒ¡ãƒªã‚«","ç¾åœ‹",[T.COUNTRY]],["ã«ã»ã‚“ï¼ˆæ—¥æœ¬ï¼‰","æ—¥æœ¬",[T.COUNTRY]]
    ];
    const L2_RAW = [
      ["ã“ã‚Œ","é€™ï¼ˆè¿‘æˆ‘ï¼‰",[]],["ãã‚Œ","é‚£ï¼ˆè¿‘ä½ ï¼‰",[]],["ã»ã‚“ï¼ˆæœ¬ï¼‰","æ›¸",[]],["ã˜ã—ã‚‡ï¼ˆè¾æ›¸ï¼‰","å­—å…¸",[]],["ãˆã„ã”ï¼ˆè‹±èªï¼‰","è‹±èª",[]],["ã«ã»ã‚“ã”ï¼ˆæ—¥æœ¬èªï¼‰","æ—¥èª",[]]
    ];
    const L3_RAW = [
      ["ã“ã“","é€™è£¡",[]],["ãã“","é‚£è£¡",[]],["ãã‚‡ã†ã—ã¤ï¼ˆæ•™å®¤ï¼‰","æ•™å®¤",[]],["ã¡ã‹ï¼ˆåœ°ä¸‹ï¼‰","åœ°ä¸‹",[]],["ã‚¤ã‚¿ãƒªã‚¢","ç¾©å¤§åˆ©",[T.COUNTRY]]
    ];
    const L4_RAW = [
      ["ãŠãã¾ã™ï¼ˆèµ·ãã¾ã™ï¼‰","èµ·åºŠ",[]],["ã­ã¾ã™ï¼ˆå¯ã¾ã™ï¼‰","ç¡è¦º",[]],["ã¯ã‚“ï¼ˆåŠï¼‰","åŠ",[T.TIME]],["ãªã‚“ã˜ï¼ˆä½•æ™‚ï¼‰","å¹¾é»",[T.TIME]],["ãªã‚“ã·ã‚“ï¼ˆä½•åˆ†ï¼‰","å¹¾åˆ†",[T.TIME]],
      ["ã”ãœã‚“ï¼ˆåˆå‰ï¼‰","ä¸Šåˆ",[T.TIME]],["ã”ã”ï¼ˆåˆå¾Œï¼‰","ä¸‹åˆ",[T.TIME]],["ã¾ã„ã«ã¡ï¼ˆæ¯æ—¥ï¼‰","æ¯å¤©",[T.TIME]],["ã’ã¤ã‚ˆã†ã³ï¼ˆæœˆæ›œæ—¥ï¼‰","æ˜ŸæœŸä¸€",[T.TIME]],["ã«ã¡ã‚ˆã†ã³ï¼ˆæ—¥æ›œæ—¥ï¼‰","æ˜ŸæœŸå¤©",[T.TIME]]
    ];

    function toObj([jp, zh, tags], l){
      const {kana, kanji} = parseKanjiKanaFlexible(jp);
      return {id:jp, jp, zh, kana, kanji, l, tags: tags||[]};
    }
    const L1 = L1_RAW.map(x=>toObj(x,"L1"));
    const L2 = L2_RAW.map(x=>toObj(x,"L2"));
    const L3 = L3_RAW.map(x=>toObj(x,"L3"));
    const L4 = L4_RAW.map(x=>toObj(x,"L4"));
    const ALL = [...L1,...L2,...L3,...L4];

    // ========= State =========
    let mode = "handwrite";
    let pool = [];
    let totalQ = 10;
    let qIndex = 0;
    let score = 0;
    let streak = 0, bestStreak = 0;
    let timed = false;
    let timeLeft = 60;
    let timerId = null;
    let wrongSet = [];
    let starSet = new Set(JSON.parse(localStorage.getItem("minna_stars")||"[]"));

    const $ = (s, r=document)=>r.querySelector(s);
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
    function sample(arr, n){ const a = arr.slice(); shuffle(a); return a.slice(0, n); }

    function renderBank(target, data){
      target.innerHTML = "";
      data.forEach(w=>{
        const d = document.createElement("div");
        d.className = "item";
        const jk = (w.kanji && w.kana && w.kanji!==w.kana ? `${w.kana}ï¼ˆ${w.kanji}ï¼‰` : w.jp);
        const btn = document.createElement("button");
        btn.className = "starbtn";
        btn.innerHTML = starSet.has(w.id) ? "â­ï¸" : "â˜†";
        if(starSet.has(w.id)) btn.classList.add("star-on");
        btn.onclick = ()=>{ toggleStar(w.id); btn.innerHTML = starSet.has(w.id) ? "â­ï¸" : "â˜†"; btn.classList.toggle("star-on", starSet.has(w.id)); };
        const left = document.createElement("div");
        left.innerHTML = `<div style="font-weight:900">${jk}</div><div>${w.zh}</div><div class="pill">${w.l}${w.tags.length? "ï½œ"+w.tags.join("ãƒ»"):""}</div>`;
        d.appendChild(left); d.appendChild(btn);
        target.appendChild(d);
      });
    }
    function toggleStar(id){
      if(starSet.has(id)) starSet.delete(id); else starSet.add(id);
      localStorage.setItem("minna_stars", JSON.stringify([...starSet]));
    }
    renderBank(document.getElementById("bankL1"), L1);
    renderBank(document.getElementById("bankL2"), L2);
    renderBank(document.getElementById("bankL3"), L3);
    renderBank(document.getElementById("bankL4"), L4);

    document.querySelectorAll('[data-q]').forEach(btn=>{
      btn.addEventListener('click',()=>{ totalQ = parseInt(btn.dataset.q,10); $("#qcount").textContent = "ç›®å‰ï¼š" + totalQ + " é¡Œ"; });
    });
    $("#startBtn").addEventListener("click", startQuiz);
    $("#speakBtn").addEventListener("click", speakPrompt);
    $("#restart").addEventListener("click", ()=>{ $("#summary").style.display="none"; $("#setup").style.display="block" });
    $("#retryWrong").addEventListener("click", retryWrongOnly);

    // === Handwriting Pad ===
    const pad = document.getElementById("pad");
    const ctx = pad.getContext("2d");
    let drawing = false;
    let last = null;
    const strokes = []; // each stroke: array of points
    let currentStroke = null;

    function resizePad(){
      const ratio = window.devicePixelRatio || 1;
      const rect = pad.getBoundingClientRect();
      pad.width = rect.width * ratio;
      pad.height = rect.height * ratio;
      ctx.scale(ratio, ratio);
      redrawPad();
    }
    function redrawPad(){
      ctx.clearRect(0,0,pad.width, pad.height);
      // grid
      const w = pad.clientWidth, h = pad.clientHeight;
      ctx.save();
      ctx.strokeStyle = "rgba(0,0,0,.06)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, h/2); ctx.lineTo(w, h/2);
      ctx.moveTo(w/2, 0); ctx.lineTo(w/2, h);
      ctx.stroke();
      ctx.restore();
      // strokes
      ctx.lineCap="round"; ctx.lineJoin="round"; ctx.lineWidth = 4; ctx.strokeStyle="#333";
      strokes.forEach(s=>{
        if(s.length<2) return;
        ctx.beginPath();
        ctx.moveTo(s[0].x, s[0].y);
        for(let i=1;i<s.length;i++){ ctx.lineTo(s[i].x, s[i].y); }
        ctx.stroke();
      });
    }
    function padPos(e){
      const rect = pad.getBoundingClientRect();
      const x = (e.touches? e.touches[0].clientX : e.clientX) - rect.left;
      const y = (e.touches? e.touches[0].clientY : e.clientY) - rect.top;
      return {x, y};
    }
    function startDraw(e){ drawing=true; currentStroke=[]; strokes.push(currentStroke); last = padPos(e); currentStroke.push(last); redrawPad(); e.preventDefault(); }
    function moveDraw(e){ if(!drawing) return; const p = padPos(e); currentStroke.push(p); redrawPad(); e.preventDefault(); }
    function endDraw(){ drawing=false; last=null; }

    pad.addEventListener("mousedown", startDraw);
    pad.addEventListener("mousemove", moveDraw);
    window.addEventListener("mouseup", endDraw);
    pad.addEventListener("touchstart", startDraw, {passive:false});
    pad.addEventListener("touchmove", moveDraw, {passive:false});
    window.addEventListener("touchend", endDraw);

    window.addEventListener("resize", resizePad);

    $("#padUndo").addEventListener("click", ()=>{ strokes.pop(); redrawPad(); });
    $("#padClear").addEventListener("click", ()=>{ strokes.length=0; redrawPad(); });

    let currentQ = null;
    $("#padShowAnswer").addEventListener("click", ()=>{
      if(!currentQ) return;
      const box = $("#resultBox");
      $("#resHead").textContent = "ğŸ“ æ­£è§£";
      $("#resBody").textContent = `${currentQ.kanji || currentQ.jp} â†’ ${currentQ.kana}ï½œ${currentQ.zh}`;
      box.classList.remove("bad"); box.classList.add("ok"); box.style.display="block";
      $("#selfJudgeRow").style.display="flex";
    });

    $("#padTrace").addEventListener("click", ()=>{
      if(!currentQ) return;
      // draw kana as faded text at center for tracing
      const w = pad.clientWidth, h = pad.clientHeight;
      redrawPad();
      const kana = currentQ.kana || currentQ.jp;
      const fontSize = Math.min(w,h)*0.5;
      ctx.save();
      ctx.globalAlpha = 0.15;
      ctx.fillStyle = "#000";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.font = `bold ${fontSize}px serif`;
      ctx.fillText(kana, w/2, h/2);
      ctx.restore();
      document.getElementById("traceBadge").style.display="inline-flex";
      document.getElementById("traceChar").textContent = kana;
    });

    // === Core quiz ===
    function buildPool(){
      const useL1 = $("#l1").checked, useL2 = $("#l2").checked, useL3 = $("#l3").checked, useL4 = $("#l4").checked;
      const wantSuffix = $("#tagSuffix").checked, wantCountry = $("#tagCountry").checked, wantTime = $("#tagTime").checked;
      const onlyStar = $("#onlyStar").checked;

      let p = ALL.filter(w => (w.l==="L1" && useL1) || (w.l==="L2" && useL2) || (w.l==="L3" && useL3) || (w.l==="L4" && useL4));
      if(wantSuffix || wantCountry || wantTime){
        p = p.filter(w => {
          const hasS = w.tags.includes(T.SUFFIX);
          const hasC = w.tags.includes(T.COUNTRY);
          const hasT = w.tags.includes(T.TIME);
          return (wantSuffix&&hasS) || (wantCountry&&hasC) || (wantTime&&hasT);
        });
      }
      if(onlyStar){ p = p.filter(w=> starSet.has(w.id)); }
      return p;
    }

    function startTimer(){
      if(!timed){ return; }
      clearInterval(timerId);
      $("#timeChip").style.display = "inline-block";
      $("#timeLeft").textContent = timeLeft;
      timerId = setInterval(()=>{
        timeLeft--;
        $("#timeLeft").textContent = timeLeft;
        if(timeLeft<=0){ clearInterval(timerId); endQuiz(true); }
      }, 1000);
    }
    function addBonusSeconds(n=3){
      if(!timed) return;
      timeLeft = Math.min(timeLeft + n, 999);
      $("#timeLeft").textContent = timeLeft;
      const t = document.createElement("span");
      t.textContent = `+${n}s`;
      t.style.marginLeft="6px"; t.style.color="var(--ok)"; t.style.fontWeight="900";
      const chip = $("#timeChip"); chip.appendChild(t);
      setTimeout(()=>t.remove(), 600);
    }

    $("#selfOk").addEventListener("click", ()=>selfJudge(true));
    $("#selfBad").addEventListener("click", ()=>selfJudge(false));

    function selfJudge(ok){
      const box = $("#resultBox");
      if(ok){
        score++; streak++; bestStreak = Math.max(bestStreak, streak);
        $("#score").textContent = score; $("#streak").textContent = streak;
        box.classList.remove("bad"); box.classList.add("ok");
        $("#resHead").textContent = "âœ… è¨˜éŒ„ç‚ºæ­£ç¢º";
        if(timed) addBonusSeconds(3);
      }else{
        streak=0; $("#streak").textContent = streak;
        box.classList.remove("ok"); box.classList.add("bad");
        $("#resHead").textContent = "âŒ è¨˜éŒ„ç‚ºéŒ¯èª¤";
        wrongSet.push(currentQ);
      }
      $("#nextBtn").disabled = false;
    }

    function startQuiz(){
      mode = document.querySelector('input[name="mode"]:checked').value;
      pool = buildPool();
      if(pool.length < 1){ alert("é¡Œåº«éå°ï¼šè«‹èª¿æ•´ç¯„åœæˆ–ç¯©é¸ã€‚"); return; }
      timed = $("#timed").checked;
      timeLeft = 60;

      qIndex=0; score=0; streak=0; bestStreak=0; wrongSet = [];
      $("#score").textContent = "0"; $("#streak").textContent = "0";
      $("#setup").style.display="none";
      $("#quiz").style.display="block";
      $("#summary").style.display="none";
      $("#modeTag").textContent = mode==="handwrite"?"æ‰‹å¯«":(mode==="jp2zh"?"JPâ†’ZH":(mode==="zh2jp"?"ZHâ†’JP":"æ¼¢å­—â†’å‡å"));
      startTimer();
      nextQuestion();
    }

    function nextQuestion(){
      $("#resultBox").style.display="none";
      $("#nextBtn").disabled = true;
      $("#selfJudgeRow").style.display="none";
      document.getElementById("traceBadge").style.display="none";
      if(qIndex >= totalQ){ endQuiz(); return; }
      $("#meta").textContent = `ç¬¬ ${qIndex+1} / ${totalQ} é¡Œ`;
      $("#bar").style.width = ((qIndex)/totalQ)*100 + "%";

      currentQ = pool[Math.floor(Math.random()*pool.length)];

      const starBtnHTML = `<button class="starbtn ${starSet.has(currentQ.id)?'star-on':''}" id="starQBtn" title="åŠ æ˜Ÿ">${starSet.has(currentQ.id)?'â­ï¸':'â˜†'}</button>`;

      if(mode==="handwrite"){
        $("#handwriteWrap").style.display="block";
        $("#choices").style.display="none";
        $("#qtext").innerHTML = `${currentQ.kanji || currentQ.jp}ï¼ˆè«‹å¯«ï¼šã‹ãªï¼‰ ${starBtnHTML}`;
        strokes.length=0; resizePad();
      }else{
        $("#handwriteWrap").style.display="none";
        $("#choices").style.display="grid";
        // fall back to choice modes for completeness
        const distractors = sample(pool.filter(w=> w.zh!==currentQ.zh), 2);
        const opts = shuffle([currentQ, ...distractors]);
        $("#qtext").innerHTML = `${currentQ.jp} ${starBtnHTML}`;
        renderChoices(opts.map(o=>o.zh), currentQ.zh, currentQ);
        $("#choices").dataset.prompt = currentQ.jp;
      }

      const starBtn = document.getElementById("starQBtn");
      starBtn.onclick = ()=>{ toggleStar(currentQ.id); starBtn.textContent = starSet.has(currentQ.id) ? "â­ï¸" : "â˜†"; starBtn.classList.toggle("star-on", starSet.has(currentQ.id)); };

      $("#nextBtn").onclick = ()=>{ qIndex++; nextQuestion(); };
    }

    function renderChoices(texts, correctText, qobj){
      const choices = $("#choices"); choices.innerHTML="";
      texts.forEach((txt, idx)=>{
        const div = document.createElement("div");
        div.className="choice";
        div.innerHTML = `<div class="key">${"ABC"[idx]}</div><div class="text">${txt}</div>`;
        div.addEventListener("click", ()=>onChoose(txt, correctText, qobj));
        choices.appendChild(div);
      });
    }

    function onChoose(chosenText, correctText, q){
      const ok = (chosenText === correctText);
      const box = $("#resultBox");
      const head = $("#resHead");
      const body = $("#resBody");
      if(ok){
        score++; streak++; bestStreak = Math.max(bestStreak, streak);
        $("#score").textContent = score; $("#streak").textContent = streak;
        box.classList.remove("bad"); box.classList.add("ok");
        head.textContent = "âœ… æ­£ç¢ºï¼";
        if(timed) addBonusSeconds(3);
      }else{
        streak=0; $("#streak").textContent = streak;
        box.classList.remove("ok"); box.classList.add("bad");
        head.textContent = "âŒ ç­”éŒ¯äº†";
        wrongSet.push(q);
      }
      body.textContent = `${q.jp} â†’ ${q.zh}`;
      box.style.display="block";
      $("#nextBtn").disabled = false;
    }

    function endQuiz(timeUp=false){
      clearInterval(timerId); timerId=null;
      $("#quiz").style.display="none";
      $("#summary").style.display="block";
      document.getElementById("finalScore").textContent = score;
      document.getElementById("finalTotal").textContent = totalQ;
      document.getElementById("finalStreak").textContent = bestStreak;
      document.getElementById("bar").style.width = "100%";
      $("#timeChip").style.display = "none";
      const btn = document.getElementById("retryWrong");
      btn.disabled = wrongSet.length===0;
      if(timeUp){ alert("æ™‚é–“åˆ°ï¼çœ‹çœ‹é€™å›åˆæˆç¸¾ï½"); }
    }

    function retryWrongOnly(){
      if(wrongSet.length===0){ alert("æ²’æœ‰éŒ¯é¡Œå¯é‡ç·´ï¼"); return; }
      const map = new Map();
      wrongSet.forEach(w=>map.set(w.id,w));
      pool = [...map.values()];
      mode = "handwrite";
      timed = false;
      qIndex=0; score=0; streak=0; bestStreak=0;
      document.getElementById("score").textContent = "0";
      document.getElementById("streak").textContent = "0";
      document.getElementById("modeTag").textContent = "æ‰‹å¯«";
      document.getElementById("summary").style.display="none";
      document.getElementById("quiz").style.display="block";
      nextQuestion();
    }

    function speakPrompt(){
      const utter = new SpeechSynthesisUtterance((currentQ?.kanji || currentQ?.jp || ""));
      utter.lang = "ja-JP";
      speechSynthesis.stop();
      speechSynthesis.speak(utter);
    }

    // initial
    setTimeout(resizePad, 50);
  </script>
</body>
</html>
