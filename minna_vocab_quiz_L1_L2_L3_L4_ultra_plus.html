<<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>å¤§å®¶çš„æ—¥æœ¬èª N5ï½œL1â€“L4 å–®å­—å°è€ƒï¼ˆå›ºå®šé¡Œåº«ï¼‰</title>
  <style>
    :root{ --bg1:#fff6dc; --bg2:#ffeec5; --paper:#fff7da; --ink:#1d1608; --accent:#d9983d; --accent-d:#b67a2f; --ok:#2e7d32; --bad:#c62828; --shadow:0 10px 20px rgba(0,0,0,.08); }
    html,body{height:100%}
    body{margin:0;font-family: ui-rounded,"SF Pro Rounded",-apple-system,system-ui,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif;color:var(--ink);
      background: radial-gradient(120% 120% at 0% 0%, var(--bg1), var(--bg2));
      background-attachment:fixed; -webkit-tap-highlight-color: transparent;}
    .app{min-height:100dvh;display:flex;flex-direction:column}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 14px;background:#ffffffb3;backdrop-filter: blur(6px);border-bottom:1px dashed rgba(0,0,0,.08)}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:14px;background:var(--paper);display:grid;place-items:center;font-weight:900;color:var(--accent);box-shadow:inset 0 0 0 2px rgba(0,0,0,.06)}
    .title{font-weight:900;color:var(--accent)}
    .hud{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .chip{background:var(--paper);padding:6px 10px;border-radius:999px;font-weight:900;box-shadow:var(--shadow)}
    .home-link{ text-decoration:none;background:#fff;color:var(--accent);font-weight:900;border-radius:999px;padding:6px 12px;box-shadow:inset 0 0 0 2px var(--accent);transition:background .1s }
    .home-link:hover{background:var(--paper)}
    main{flex:1;padding:14px;display:flex}
    .card{margin:auto;width:min(1000px,100%);background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:18px;box-shadow:var(--shadow);padding:16px 14px}
    .section{display:flex;flex-direction:column;gap:12px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:900;box-shadow:0 6px 0 var(--accent-d)}
    .btn:active{transform:translateY(2px);box-shadow:0 4px 0 var(--accent-d)}
    .ghost{background:#fff;color:var(--accent);box-shadow: inset 0 0 0 2px var(--accent)}
    .pill{background:#fff;border:1px solid rgba(0,0,0,.08);padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800}
    .title2{font-weight:900;color:#5f430e}
    .qtext{display:flex;align-items:center;gap:10px;font-size:1.6rem;font-weight:900;line-height:1.6;word-break:keep-all}
    .starbtn{border:0;background:transparent;font-size:1.4rem;cursor:pointer}
    .choices{display:grid;grid-template-columns:1fr;gap:10px}
    .choice{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:14px 12px;font-size:1.1rem;font-weight:800;box-shadow:var(--shadow)}
    .choice:active{transform:scale(.99)}
    .key{min-width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:var(--paper);color:var(--accent);border:1px solid rgba(0,0,0,.06)}
    .result{margin-top:10px;padding:10px;border-radius:12px;border:2px dashed rgba(0,0,0,.12);display:none}
    .result.ok{border-color:#7cb34266}
    .result.bad{border-color:#e5393566}
    footer{position:sticky;bottom:0;z-index:10;padding:8px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px;background:#ffffffb3;backdrop-filter: blur(6px);border-top:1px dashed rgba(0,0,0,.08)}
    .meter{flex:1;display:flex;gap:10px;align-items:center}
    .progress{height:12px;background:#fff;border:1px solid rgba(0,0,0,.1);border-radius:999px;overflow:hidden;flex:1}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#d9983d,#f7c66d)}
    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:8px}
    .item{background:var(--paper);padding:10px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .hint{opacity:.85;font-size:.95rem}
    .lesson-note{margin:6px 0 2px;font-weight:800;opacity:.9}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">å˜</div>
        <div class="title">å¤§å®¶çš„æ—¥æœ¬èª N5ï½œL1â€“L4 å–®å­—å°è€ƒï¼ˆå›ºå®šé¡Œåº«ï¼‰</div>
      </div>
      <div class="hud">
        <div class="chip">åˆ†æ•¸ <span id="score">0</span></div>
        <div class="chip">é€£å° <span id="streak">0</span></div>
        <div class="chip" id="timeChip" style="display:none">â± <span id="timeLeft">60</span>s</div>
        <a href="#" class="home-link" onclick="location.reload()">ğŸ  å›é¦–é </a>
      </div>
    </header>
    <main>
      <section class="card section" id="setup">
        <div class="title2">æ¨¡å¼</div>
        <div class="grid">
          <label class="row"><input type="radio" name="mode" value="jp2zh" checked> <span class="pill">çœ‹åˆ°æ—¥æ–‡ â†’ é¸ä¸­æ–‡</span></label>
          <label class="row"><input type="radio" name="mode" value="zh2jp"> <span class="pill">çœ‹åˆ°ä¸­æ–‡ â†’ é¸æ—¥æ–‡</span></label>
          <label class="row"><input type="radio" name="mode" value="kanji2kana"> <span class="pill">è®€éŸ³æ¨¡å¼ï¼šæ¼¢å­— â†’ å‡å</span></label>
        </div>

        <div class="title2">ç¯„åœ</div>
        <div class="row">
          <label class="pill"><input type="checkbox" id="useL1" checked> L1</label>
          <label class="pill"><input type="checkbox" id="useL2" checked> L2</label>
          <label class="pill"><input type="checkbox" id="useL3" checked> L3</label>
          <label class="pill"><input type="checkbox" id="useL4" checked> L4</label>
        </div>

        <div class="title2">æ¨™ç±¤ç¯©é¸</div>
        <div class="row">
          <label class="pill"><input type="checkbox" id="tagSuffix"> æ¥å°¾è©</label>
          <label class="pill"><input type="checkbox" id="tagCountry"> åœ‹å®¶</label>
          <label class="pill"><input type="checkbox" id="tagTime"> æ™‚é–“é¡</label>
          <span class="pill"><input type="checkbox" id="onlyStar"> åªå‡º â­ï¸ æ˜Ÿè™Ÿå–®å­—</span>
        </div>

        <div class="title2">é¡Œæ•¸ & é¡¯ç¤º</div>
        <div class="row">
          <button class="pill" data-q="10">10 é¡Œ</button>
          <button class="pill" data-q="20">20 é¡Œ</button>
          <span id="qcount" class="pill">ç›®å‰ï¼š10 é¡Œ</span>
        </div>
        <div class="row">
          <label class="pill"><input type="checkbox" id="timed"> é™æ™‚æ¨¡å¼ï¼ˆ60 ç§’ï¼Œé€£å° +3 ç§’ï¼‰</label>
          <label class="pill"><input type="checkbox" id="byLesson"> ä¾èª²æ¬¡é †åºï¼ˆé—œé–‰ï¼éš¨æ©Ÿæ··åˆï¼‰</label>
          <label class="pill"><input type="checkbox" id="katakanaOnly"> åªé¡¯ç¤ºç‰‡å‡å</label>
          <label class="pill"><input type="checkbox" id="showKanji" checked> é¡¯ç¤ºæ¼¢å­—</label>
          <label class="pill"><input type="checkbox" id="kanjiOptions"> ZHâ†’JP é¸é …ç”¨ã€Œæ¼¢å­—ã€</label>
        </div>

        <details>
          <summary>é¡Œåº«ä¸€è¦½ï¼ˆå¯ç›´æ¥åŠ æ˜Ÿï¼‰</summary>

          <div class="title2" style="margin-top:6px">L1</div>
          <div class="lesson-note">ğŸŸ¡ ç¬¬1èª²ï¼šè‡ªæˆ‘ä»‹ç´¹èˆ‡åœ‹ç±</div>
          <div class="list" id="bankL1"></div>

          <div class="title2" style="margin-top:10px">L2</div>
          <div class="lesson-note">ğŸŸ¡ ç¬¬2èª²ï¼šæŒ‡ç¤ºè©èˆ‡ç‰©å“åç¨±</div>
          <div class="list" id="bankL2"></div>

          <div class="title2" style="margin-top:10px">L3</div>
          <div class="lesson-note">ğŸŸ¡ ç¬¬3èª²ï¼šå ´æ‰€èˆ‡æ–¹å‘ã€æ¨“å±¤èˆ‡åƒ¹æ ¼</div>
          <div class="list" id="bankL3"></div>

          <div class="title2" style="margin-top:10px">L4</div>
          <div class="lesson-note">ğŸŸ¡ ç¬¬4èª²ï¼šæ™‚é–“ï¼ˆæ™‚ãƒ»åˆ†ãƒ»ä¸Šåˆ/ä¸‹åˆï¼‰ã€æ˜ŸæœŸ</div>
          <div class="list" id="bankL4"></div>
        </details>

        <div class="row"><button class="btn" id="startBtn">é–‹å§‹æ¸¬é©— â–¶</button></div>
      </section>

      <section class="card section" id="quiz" style="display:none">
        <div class="row"><span class="pill" id="meta">ç¬¬ 1 / 10 é¡Œ</span><span class="pill" id="modeTag">JPâ†’ZH</span></div>
        <div class="qtext" id="qtext">å•é¡Œ</div>
        <div class="choices" id="choices"></div>
        <div class="result" id="resultBox">
          <div id="resHead" style="font-weight:900;margin-bottom:4px"></div>
          <div id="resBody"></div>
        </div>
        <div class="row">
          <button class="btn" id="nextBtn" disabled>ä¸‹ä¸€é¡Œ â†’</button>
          <button class="ghost" id="speakBtn">æœ—è®€</button>
        </div>
      </section>

      <section class="card section" id="summary" style="display:none">
        <div class="title2">å®Œæˆï¼</div>
        <div>åˆ†æ•¸ï¼š<b id="finalScore">0</b> ï¼ é¡Œæ•¸ï¼š<b id="finalTotal">0</b></div>
        <div>æœ€ä½³é€£å°ï¼š<b id="finalStreak">0</b></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="retryWrong" disabled>éŒ¯é¡Œé‡ç·´ â–¶</button>
          <button class="ghost" id="restart">å›åˆ°è¨­å®šé </button>
        </div>
      </section>
    </main>

    <footer>
      <div class="meter">
        <span class="pill">é€²åº¦</span>
        <div class="progress"><div class="bar" id="bar"></div></div>
      </div>
    </footer>
  </div>

  <script>
    const T = { SUFFIX:"æ¥å°¾è©", COUNTRY:"åœ‹å®¶", TIME:"æ™‚é–“" };
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];

    // ---- åå¥½å„²å­˜éµ ----
    const PREF_KEY = 'n5_l1_4_prefs_v1';
    const STAR_KEY = 'n5_fixed_bank_stars_v1';

    // ---- è§£æå·¥å…· ----
    function parseKanjiKanaFlexible(jp){
      let m = jp.match(/^(.*)ï¼ˆ(.*)ï¼‰$/);
      if(m){ return {kana:m[1], kanji:m[2]} }
      m = jp.match(/^(.*)\((.*)\)$/);
      if(m){ return {kana:m[1], kanji:m[2]} }
      return {kana:jp, kanji:jp};
    }
    function hiraToKata(str){ return str.replace(/[ã-ã‚–]/g, ch => String.fromCharCode(ch.charCodeAt(0)+0x60)); }
    function toKatakanaIf(s,on){ return on ? hiraToKata(s) : s; }

    // ---- é¡¯ç¤ºå·¥å…· ----
    function displayKana(word, katakanaOn){
      const k = word.kana || word.jp;
      return katakanaOn ? hiraToKata(k) : k;
    }
    function displayJP(word, showKanji, katakanaOn){
      if(!showKanji){ return displayKana(word, katakanaOn); }
      if(word.kanji && word.kana && word.kanji!==word.kana){
        return `${displayKana(word, katakanaOn)}ï¼ˆ${word.kanji}ï¼‰`;
      }
      const s = word.jp || word.kana;
      return katakanaOn ? hiraToKata(s) : s;
    }

    // ---- é¡Œåº« ----
    const L1_RAW = [
      ["ã‚ãŸã—","æˆ‘",[]],["ã‚ãªãŸ","ä½ ã€æ‚¨",[]],["ã‚ã®ã²ã¨ï¼ˆã‚ã®äººï¼‰","ä»–ã€å¥¹ã€é‚£å€‹äºº",[]],["ã‚ã®ã‹ãŸï¼ˆã‚ã®æ–¹ï¼‰","ã€Œã‚ã®äººã€çš„ç¦®è²Œèªªæ³•",[]],
      ["ã€œã•ã‚“","ã€œå…ˆç”Ÿã€ã€œå°å§ã€ã€œå¥³å£«ï¼ˆæ¥å°¾ï¼‰",[T.SUFFIX]],["ã€œã¡ã‚ƒã‚“","ä»£æ›¿ã€Œã€œã•ã‚“ã€ï¼Œæ¥åœ¨å°å­©å­åå­—å¾Œï¼ˆæ¥å°¾ï¼‰",[T.SUFFIX]],["ã€œã˜ã‚“","ã€œäººï¼ˆè¡¨ç¤ºåœ‹ç±çš„æ¥å°¾è©ï¼‰",[T.SUFFIX]],
      ["ã›ã‚“ã›ã„ï¼ˆå…ˆç”Ÿï¼‰","è€å¸«",[]],["ãã‚‡ã†ã—ï¼ˆæ•™å¸«ï¼‰","æ•™å¸«",[]],["ãŒãã›ã„ï¼ˆå­¦ç”Ÿï¼‰","å­¸ç”Ÿ",[]],["ã‹ã„ã—ã‚ƒã„ã‚“ï¼ˆä¼šç¤¾å“¡ï¼‰","å…¬å¸è·å“¡",[]],["ã—ã‚ƒã„ã‚“ï¼ˆç¤¾å“¡ï¼‰","å…¬å¸è·å“¡",[]],
      ["ãã‚“ã“ã†ã„ã‚“ï¼ˆéŠ€è¡Œå“¡ï¼‰","éŠ€è¡Œè¡Œå“¡",[]],["ã„ã—ã‚ƒï¼ˆåŒ»è€…ï¼‰","é†«ç”Ÿ",[]],["ã‘ã‚“ãã‚…ã†ã—ã‚ƒï¼ˆç ”ç©¶è€…ï¼‰","ç ”ç©¶äººå“¡",[]],["ã ã„ãŒãï¼ˆå¤§å­¦ï¼‰","å¤§å­¸",[]],["ã³ã‚‡ã†ã„ã‚“ï¼ˆç—…é™¢ï¼‰","é†«é™¢",[]],
      ["ã ã‚Œï¼ˆèª°ï¼‰","èª°ï¼ˆå“ªä½ï¼‰",[]],["ã©ãªãŸ","ã€Œã ã‚Œã€çš„ç¦®è²Œèªªæ³•",[]],["ã€œã•ã„ï¼ˆã€œæ­³ï¼‰","ã€œæ­²",[]],["ãªã‚“ã•ã„ï¼ˆä½•æ­³ï¼‰","å¹¾æ­²",[]],["ãŠã„ãã¤","ã€Œãªã‚“ã•ã„ã€çš„ç¦®è²Œèªªæ³•",[]],
      ["ã¯ã„","æ˜¯ã€å°",[]],["ã„ã„ãˆ","ä¸ã€ä¸æ˜¯",[]],["ã¯ã˜ã‚ã¾ã—ã¦ã€‚","åˆæ¬¡è¦‹é¢ã€‚",[]],["ã€œã‹ã‚‰ãã¾ã—ãŸã€‚","å¾ã€œä¾†çš„ã€‚",[]],["ã©ã†ãã‚ˆã‚ã—ããŠã­ãŒã„ã—ã¾ã™ã€‚","è«‹å¤šé—œç…§ï¼è«‹å¤šæŒ‡æ•™ã€‚",[]],
      ["ã—ã¤ã‚Œã„ã§ã™ãŒï¼ˆå¤±ç¤¼ã§ã™ãŒï¼‰","æŠ±æ­‰ï¼Œè«‹å•â€¦",[]],["ãŠãªã¾ãˆã¯ï¼Ÿï¼ˆãŠåå‰ã¯ï¼Ÿï¼‰","æ‚¨è²´å§“ï¼Ÿæ‚¨å«ä»€éº¼åå­—ï¼Ÿ",[]],["ã“ã¡ã‚‰ã¯ã€œã•ã‚“ã§ã™ã€‚","é€™ä½æ˜¯ã€œã€‚",[]],
      ["ã‚¢ãƒ¡ãƒªã‚«","ç¾åœ‹",[T.COUNTRY]],["ã‚¤ã‚®ãƒªã‚¹","è‹±åœ‹",[T.COUNTRY]],["ã‚¤ãƒ³ãƒ‰","å°åº¦",[T.COUNTRY]],["ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢","å°å°¼",[T.COUNTRY]],["ã‹ã‚“ã“ãï¼ˆéŸ“å›½ï¼‰","éŸ“åœ‹",[T.COUNTRY]],
      ["ã‚¿ã‚¤","æ³°åœ‹",[T.COUNTRY]],["ã¡ã‚…ã†ã”ãï¼ˆä¸­å›½ï¼‰","ä¸­åœ‹",[T.COUNTRY]],["ãƒ‰ã‚¤ãƒ„","å¾·åœ‹",[T.COUNTRY]],["ã«ã»ã‚“ï¼ˆæ—¥æœ¬ï¼‰","æ—¥æœ¬",[T.COUNTRY]],["ãƒ–ãƒ©ã‚¸ãƒ«","å·´è¥¿",[T.COUNTRY]]
    ];
    const L2_RAW = [
      ["ã“ã‚Œ","é€™(é›¢èªªè©±è€…è¿‘çš„æ±è¥¿)",[]],["ãã‚Œ","é‚£(é›¢è½è€…è¿‘çš„æ±è¥¿)",[]],["ã‚ã‚Œ","é‚£(é›¢èªªè©±è€…ã€è½è€…éƒ½é çš„æ±è¥¿)",[]],["ã“ã®ã€œ","é€™å€‹~",[]],["ãã®ã€œ","é‚£å€‹~ï¼ˆè¿‘å°æ–¹ï¼‰",[]],["ã‚ã®ã€œ","é‚£å€‹~ï¼ˆé ï¼‰",[]],
      ["ã»ã‚“ï¼ˆæœ¬ï¼‰","æ›¸",[]],["ã˜ã—ã‚‡ï¼ˆè¾æ›¸ï¼‰","å­—å…¸",[]],["ã–ã£ã—ï¼ˆé›‘èªŒï¼‰","é›œèªŒ",[]],["ã—ã‚“ã¶ã‚“ï¼ˆæ–°èï¼‰","å ±ç´™",[]],["ãƒãƒ¼ãƒˆ","ç­†è¨˜æœ¬",[]],["ã¦ã¡ã‚‡ã†ï¼ˆæ‰‹å¸³ï¼‰","è¨˜äº‹æœ¬",[]],["ã‚ã„ã—ï¼ˆååˆºï¼‰","åç‰‡",[]],
      ["ã‚«ãƒ¼ãƒ‰","å¡ç‰‡",[]],["ãˆã‚“ã´ã¤ï¼ˆé‰›ç­†ï¼‰","é‰›ç­†",[]],["ãƒœãƒ¼ãƒ«ãƒšãƒ³","åŸå­ç­†",[]],["ã‚·ãƒ£ãƒ¼ãƒ—ãƒšãƒ³ã‚·ãƒ«","è‡ªå‹•é‰›ç­†",[]],["ã‹ã","é‘°åŒ™",[]],["ã¨ã‘ã„ï¼ˆæ™‚è¨ˆï¼‰","é˜éŒ¶",[]],["ã‹ã•ï¼ˆå‚˜ï¼‰","å‚˜",[]],
      ["ã‹ã°ã‚“","çš®åŒ…ã€æåŒ…",[]],["ã‚·ãƒ¼ãƒ‡ã‚£ãƒ¼ï¼ˆCDï¼‰","CDã€å…‰ç¢Ÿ",[]],["ãƒ†ãƒ¬ãƒ“","é›»è¦–",[]],["ãƒ©ã‚¸ã‚ª","æ”¶éŸ³æ©Ÿ",[]],["ã‚«ãƒ¡ãƒ©","ç…§ç›¸æ©Ÿ",[]],["ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼","é›»è…¦",[]],["ãã‚‹ã¾ï¼ˆè»Šï¼‰","æ±½è»Š",[]],
      ["ã¤ããˆï¼ˆæœºï¼‰","æ¡Œå­",[]],["ã„ã™","æ¤…å­",[]],["ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ","å·§å…‹åŠ›",[]],["ã‚³ãƒ¼ãƒ’ãƒ¼","å’–å•¡",[]],["[ãŠ]ã¿ã‚„ã’","ä¼´æ‰‹ç¦®ã€åœŸç”¢",[]],["ãˆã„ã”ï¼ˆè‹±èªï¼‰","è‹±èª",[]],
      ["ã«ã»ã‚“ã”ï¼ˆæ—¥æœ¬èªï¼‰","æ—¥èª",[]],["ã€œã”ï¼ˆã€œèªï¼‰","ã€œèª",[]],["ãªã‚“ï¼ˆä½•ï¼‰","ä»€éº¼",[]],["ãã†ã§ã™","æ˜¯çš„",[]],["ã“ã‚Œã‹ã‚‰ãŠä¸–è©±ã«ãªã‚Šã¾ã™ã€‚","ä»Šå¾Œå°‡æ‰¿è’™æ‚¨çš„ç…§é¡§ã€‚",[]],
      ["ã“ã¡ã‚‰ã“ã[ã©ã†ã]ã‚ˆã‚ã—ã[ãŠé¡˜ã„ã—ã¾ã™]ã€‚","å“ªè£¡å“ªè£¡ï¼Œä¹Ÿè«‹æ‚¨å¤šå¤šæŒ‡æ•™ã€‚",[]],["ã‚ã®ã†","é‚£å€‹â‹¯ï¼ˆå®¢æ°£ã€èºŠèº‡åœ°æ­è©±ï¼‰",[]],["ãˆã£ã€‚","å’¦â‹¯ï¼ˆè½åˆ°æ„å¤–æ¶ˆæ¯æ™‚ï¼‰",[]],["ã©ã†ãã€‚","è«‹ã€‚ï¼ˆå‹¸å°æ–¹â€¦ï¼‰",[]]
    ];
    const L3_RAW = [
      ["ã“ã“","é€™è£¡",[]],["ãã“","é‚£è£¡",[]],["ã‚ãã“","é‚£é‚Š",[]],["ã©ã“","å“ªè£¡",[]],
      ["ã“ã¡ã‚‰","é€™é‚Šï¼ˆç¦®è²Œï¼‰",[]],["ãã¡ã‚‰","é‚£é‚Šï¼ˆç¦®è²Œï¼‰",[]],["ã‚ã¡ã‚‰","é‚£é‚Šï¼ˆç¦®è²Œï¼‰",[]],["ã©ã¡ã‚‰","å“ªé‚Šï¼ˆç¦®è²Œï¼‰",[]],
      ["ãã‚‡ã†ã—ã¤ï¼ˆæ•™å®¤ï¼‰","æ•™å®¤",[]],["ã—ã‚‡ãã©ã†ï¼ˆé£Ÿå ‚ï¼‰","é¤å»³",[]],["ã˜ã‚€ã—ã‚‡ï¼ˆäº‹å‹™æ‰€ï¼‰","è¾¦å…¬å®¤",[]],["ã‹ã„ãã—ã¤ï¼ˆä¼šè­°å®¤ï¼‰","æœƒè­°å®¤",[]],
      ["ã†ã‘ã¤ã‘ï¼ˆå—ä»˜ï¼‰","æ¥å¾…è™•",[]],["ãƒ­ãƒ“ãƒ¼","å¤§å»³",[]],["ã¸ã‚„ï¼ˆéƒ¨å±‹ï¼‰","æˆ¿é–“",[]],["ãƒˆã‚¤ãƒ¬","å»æ‰€",[]],
      ["ã‹ã„ã ã‚“ï¼ˆéšæ®µï¼‰","æ¨“æ¢¯",[]],["ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼","é›»æ¢¯",[]],["ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚¿ãƒ¼","æ‰‹æ‰¶æ¢¯",[]],["ã˜ã©ã†ã¯ã‚“ã°ã„ãï¼ˆè‡ªå‹•è²©å£²æ©Ÿï¼‰","è‡ªå‹•è²©è³£æ©Ÿ",[]],
      ["ã§ã‚“ã‚ï¼ˆé›»è©±ï¼‰","é›»è©±",[]],["ãã«ï¼ˆå›½ï¼‰","åœ‹å®¶",[T.COUNTRY]],["ã‹ã„ã—ã‚ƒï¼ˆä¼šç¤¾ï¼‰","å…¬å¸",[]],["ã†ã¡","å®¶",[]],
      ["ãã¤ï¼ˆé´ï¼‰","é‹å­",[]],["ãƒã‚¯ã‚¿ã‚¤","é ˜å¸¶",[]],["ãƒ¯ã‚¤ãƒ³","ç´…é…’",[]],["ã†ã‚Šã°ï¼ˆå£²ã‚Šå ´ï¼‰","è³£å ´",[]],["ã¡ã‹ï¼ˆåœ°ä¸‹ï¼‰","åœ°ä¸‹",[]],
      ["ãªã‚“ãŒã„ï¼ˆä½•éšï¼‰","å¹¾æ¨“",[]],["ã€œãˆã‚“ï¼ˆã€œå††ï¼‰","ã€œåœ“",[]],["ã„ãã‚‰","å¤šå°‘éŒ¢",[]],
      ["ã²ã‚ƒãï¼ˆç™¾ï¼‰","ä¸€ç™¾",[]],["ã›ã‚“ï¼ˆåƒï¼‰","ä¸€åƒ",[]],["ã¾ã‚“ï¼ˆä¸‡ï¼‰","ä¸€è¬",[]]
    ];
    const L4_RAW = [
      ["ãŠãã¾ã™ï¼ˆèµ·ãã¾ã™ï¼‰","èµ·åºŠ",[]],["ã­ã¾ã™ï¼ˆå¯ã¾ã™ï¼‰","ç¡è¦º",[]],["ã¯ãŸã‚‰ãã¾ã™ï¼ˆåƒãã¾ã™ï¼‰","å·¥ä½œ",[]],["ã‚„ã™ã¿ã¾ã™ï¼ˆä¼‘ã¿ã¾ã™ï¼‰","ä¼‘æ¯",[]],
      ["ã¹ã‚“ãã‚‡ã†ã—ã¾ã™ï¼ˆå‹‰å¼·ã—ã¾ã™ï¼‰","å¿µæ›¸",[]],["ãŠã‚ã‚Šã¾ã™ï¼ˆçµ‚ã‚ã‚Šã¾ã™ï¼‰","çµæŸ",[]],
      ["ãƒ‡ãƒ‘ãƒ¼ãƒˆ","ç™¾è²¨å…¬å¸",[]],["ãã‚“ã“ã†ï¼ˆéŠ€è¡Œï¼‰","éŠ€è¡Œ",[]],["ã‚†ã†ã³ã‚“ãã‚‡ãï¼ˆéƒµä¾¿å±€ï¼‰","éƒµå±€",[]],
      ["ã¨ã—ã‚‡ã‹ã‚“ï¼ˆå›³æ›¸é¤¨ï¼‰","åœ–æ›¸é¤¨",[]],["ã³ã˜ã‚…ã¤ã‹ã‚“ï¼ˆç¾è¡“é¤¨ï¼‰","ç¾è¡“é¤¨",[]],
      ["ã„ã¾ï¼ˆä»Šï¼‰","ç¾åœ¨",[T.TIME]],["ã€œã˜ï¼ˆã€œæ™‚ï¼‰","ã€œé»é˜",[T.TIME]],["ã€œãµã‚“ï¼ˆã€œåˆ†ï¼‰","ã€œåˆ†",[T.TIME]],["ã¯ã‚“ï¼ˆåŠï¼‰","åŠ",[T.TIME]],
      ["ãªã‚“ã˜ï¼ˆä½•æ™‚ï¼‰","å¹¾é»",[T.TIME]],["ãªã‚“ã·ã‚“ï¼ˆä½•åˆ†ï¼‰","å¹¾åˆ†",[T.TIME]],
      ["ã”ãœã‚“ï¼ˆåˆå‰ï¼‰","ä¸Šåˆ",[T.TIME]],["ã”ã”ï¼ˆåˆå¾Œï¼‰","ä¸‹åˆ",[T.TIME]],["ã‚ã•ï¼ˆæœï¼‰","æ—©ä¸Š",[T.TIME]],
      ["ã²ã‚‹ï¼ˆæ˜¼ï¼‰","ä¸­åˆ",[T.TIME]],["ã°ã‚“ï¼ˆæ™©ï¼‰ï¼ã‚ˆã‚‹ï¼ˆå¤œï¼‰","æ™šä¸Š",[T.TIME]],["ã‘ã•ï¼ˆä»Šæœï¼‰","ä»Šå¤©æ—©ä¸Š",[T.TIME]],["ã“ã‚“ã°ã‚“ï¼ˆä»Šæ™©ï¼‰","ä»Šå¤©æ™šä¸Š",[T.TIME]],
      ["ã‚„ã™ã¿ï¼ˆä¼‘ã¿ï¼‰","ä¼‘å‡",[]],["ã²ã‚‹ã‚„ã™ã¿ï¼ˆæ˜¼ä¼‘ã¿ï¼‰","åˆä¼‘",[]],
      ["ã¾ã„ã‚ã•ï¼ˆæ¯æœï¼‰","æ¯å¤©æ—©ä¸Š",[T.TIME]],["ã¾ã„ã°ã‚“ï¼ˆæ¯æ™©ï¼‰","æ¯å¤©æ™šä¸Š",[T.TIME]],["ã¾ã„ã«ã¡ï¼ˆæ¯æ—¥ï¼‰","æ¯å¤©",[T.TIME]],
      ["ã’ã¤ã‚ˆã†ã³ï¼ˆæœˆæ›œæ—¥ï¼‰","æ˜ŸæœŸä¸€",[]],["ã‹ã‚ˆã†ã³ï¼ˆç«æ›œæ—¥ï¼‰","æ˜ŸæœŸäºŒ",[]],["ã™ã„ã‚ˆã†ã³ï¼ˆæ°´æ›œæ—¥ï¼‰","æ˜ŸæœŸä¸‰",[]],
      ["ã‚‚ãã‚ˆã†ã³ï¼ˆæœ¨æ›œæ—¥ï¼‰","æ˜ŸæœŸå››",[]],["ãã‚“ã‚ˆã†ã³ï¼ˆé‡‘æ›œæ—¥ï¼‰","æ˜ŸæœŸäº”",[]],
      ["ã©ã‚ˆã†ã³ï¼ˆåœŸæ›œæ—¥ï¼‰","æ˜ŸæœŸå…­",[]],["ã«ã¡ã‚ˆã†ã³ï¼ˆæ—¥æ›œæ—¥ï¼‰","æ˜ŸæœŸæ—¥",[]],["ãªã‚“ã‚ˆã†ã³ï¼ˆä½•æ›œæ—¥ï¼‰","æ˜ŸæœŸå¹¾",[]],
      ["ã°ã‚“ã”ã†ï¼ˆç•ªå·ï¼‰","è™Ÿç¢¼",[]],["ãªã‚“ã°ã‚“ï¼ˆä½•ç•ªï¼‰","å¹¾è™Ÿ",[]]
    ];

    function normalize(raw, lesson){
      return raw.map(([jp, zh, tags])=>{
        const {kana, kanji} = parseKanjiKanaFlexible(jp);
        return { jp, kana, kanji, zh, tags: tags||[], lesson };
      });
    }
    const BANK_ALL = [...normalize(L1_RAW,'L1'),...normalize(L2_RAW,'L2'),...normalize(L3_RAW,'L3'),...normalize(L4_RAW,'L4')];

    // ---- æ˜Ÿè™Ÿæ”¶è— ----
    const starSet=new Set(JSON.parse(localStorage.getItem(STAR_KEY)||'[]'));
    function saveStars(){ localStorage.setItem(STAR_KEY, JSON.stringify([...starSet])); }
    function isStarred(item){ return starSet.has(item.jp+'|'+item.zh); }

    // ---- DOM ----
    const els = {
      setup:$('#setup'), quiz:$('#quiz'), summary:$('#summary'),
      qtext:$('#qtext'), choices:$('#choices'), nextBtn:$('#nextBtn'), speakBtn:$('#speakBtn'),
      resBox:$('#resultBox'), resHead:$('#resHead'), resBody:$('#resBody'),
      meta:$('#meta'), modeTag:$('#modeTag'), bar:$('#bar'),
      score:$('#score'), streak:$('#streak'),
      timeChip:$('#timeChip'), timeLeft:$('#timeLeft'),
      finalScore:$('#finalScore'), finalTotal:$('#finalTotal'), finalStreak:$('#finalStreak'),
      retryWrong:$('#retryWrong'), restart:$('#restart'),
      qcount:$('#qcount'), startBtn:$('#startBtn'),
      useL1:$('#useL1'), useL2:$('#useL2'), useL3:$('#useL3'), useL4:$('#useL4'),
      tagSuffix:$('#tagSuffix'), tagCountry:$('#tagCountry'), tagTime:$('#tagTime'),
      onlyStar:$('#onlyStar'), byLesson:$('#byLesson'), timed:$('#timed'),
      katakanaOnly:$('#katakanaOnly'), showKanji:$('#showKanji'), kanjiOptions:$('#kanjiOptions'),
      bankL1:$('#bankL1'), bankL2:$('#bankL2'), bankL3:$('#bankL3'), bankL4:$('#bankL4'),
    };

    // ---- ç‹€æ…‹ ----
    const S={mode:'jp2zh', total:10, idx:0, score:0, streak:0, bestStreak:0, questions:[], wrongPool:[], timeLeft:60, timerId:null, running:false};

    // ---- åå¥½å­˜å– ----
    function savePrefs(){
      const prefs = {
        // ç¯„åœ
        useL1:els.useL1.checked, useL2:els.useL2.checked, useL3:els.useL3.checked, useL4:els.useL4.checked,
        // æ¨™ç±¤
        tagSuffix:els.tagSuffix.checked, tagCountry:els.tagCountry.checked, tagTime:els.tagTime.checked, onlyStar:els.onlyStar.checked,
        // é¡¯ç¤º
        timed:els.timed.checked, byLesson:els.byLesson.checked, katakanaOnly:els.katakanaOnly.checked, showKanji:els.showKanji.checked, kanjiOptions:els.kanjiOptions.checked,
        // å…¶ä»–
        total:S.total, mode:S.mode
      };
      localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
    }
    function loadPrefs(){
      try{
        const raw = localStorage.getItem(PREF_KEY);
        if(!raw) return;
        const p = JSON.parse(raw);
        // å¥—ç”¨ checkbox
        ['useL1','useL2','useL3','useL4','tagSuffix','tagCountry','tagTime','onlyStar','timed','byLesson','katakanaOnly','showKanji','kanjiOptions'].forEach(k=>{
          if(typeof p[k]==='boolean'){ els[k].checked = p[k]; }
        });
        if(typeof p.total==='number'){ S.total=p.total; els.qcount.textContent=`ç›®å‰ï¼š${S.total} é¡Œ`; }
        if(typeof p.mode==='string'){ S.mode=p.mode; const r=document.querySelector(`input[name="mode"][value="${S.mode}"]`); if(r) r.checked=true; }
      }catch(e){}
    }

    // ---- é¡Œåº«æ¸…å–®ï¼ˆé¡¯ç¤ºï¼‰----
    function renderBankList(container, items){
      const katakanaOnly = els.katakanaOnly.checked;
      const showKanji = els.showKanji.checked;
      container.innerHTML='';
      items.forEach(item=>{
        const id=item.jp+'|'+item.zh;
        const div=document.createElement('div'); div.className='item';
        const left=document.createElement('div'); left.style.display='grid'; left.style.gap='2px';

        const top=document.createElement('div'); top.style.fontWeight='900';
        top.textContent = displayJP(item, showKanji, katakanaOnly);

        const mid=document.createElement('div'); mid.className='hint'; mid.textContent=`ä¸­æ–‡ï¼š${item.zh}`;

        const tag=document.createElement('div'); tag.className='hint';
        if(item.kanji!==item.kana){ tag.textContent=`è®€éŸ³ï¼š${toKatakanaIf(item.kana, katakanaOnly)}ï¼æ¼¢å­—ï¼š${item.kanji}`; }
        else { tag.textContent=`è®€éŸ³ï¼š${toKatakanaIf(item.kana, katakanaOnly)}`; }

        left.append(top, mid, tag);

        const star=document.createElement('button'); star.className='starbtn'; star.innerHTML=isStarred(item)?'â­ï¸':'â˜†';
        star.addEventListener('click',()=>{ if(isStarred(item)){ starSet.delete(id); star.innerHTML='â˜†'; } else { starSet.add(id); star.innerHTML='â­ï¸'; } saveStars(); });

        div.append(left,star); container.appendChild(div);
      });
    }
    function renderBankListsWithSettings(){
      renderBankList(els.bankL1, BANK_ALL.filter(x=>x.lesson==='L1'));
      renderBankList(els.bankL2, BANK_ALL.filter(x=>x.lesson==='L2'));
      renderBankList(els.bankL3, BANK_ALL.filter(x=>x.lesson==='L3'));
      renderBankList(els.bankL4, BANK_ALL.filter(x=>x.lesson==='L4'));
    }

    // ---- å·¥å…· ----
    function sample(arr,n){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a.slice(0,n); }
    function shuffle(arr){ return sample(arr, arr.length); }

    function getFilteredBank(){
      const use=new Set(); if(els.useL1.checked)use.add('L1'); if(els.useL2.checked)use.add('L2'); if(els.useL3.checked)use.add('L3'); if(els.useL4.checked)use.add('L4');
      const wantS=els.tagSuffix.checked, wantC=els.tagCountry.checked, wantT=els.tagTime.checked, onlyStar=els.onlyStar.checked;
      return BANK_ALL.filter(it=>{
        if(!use.has(it.lesson)) return false;
        if(onlyStar && !isStarred(it)) return false;
        const any=wantS||wantC||wantT;
        if(any){
          const set=new Set(it.tags);
          if(wantS&&set.has(T.SUFFIX)) return true;
          if(wantC&&set.has(T.COUNTRY)) return true;
          if(wantT&&set.has(T.TIME)) return true;
          return false;
        }
        return true;
      });
    }

    // ---- å‡ºé¡Œ ----
    function buildQuestionPool(){
      const pool=getFilteredBank(); if(pool.length===0) return [];
      const picked = els.byLesson.checked
        ? ['L1','L2','L3','L4'].flatMap(L=>shuffle(pool.filter(x=>x.lesson===L))).slice(0,S.total)
        : sample(pool, Math.min(S.total, pool.length));

      const katakanaOnly = els.katakanaOnly.checked;
      const showKanji = els.showKanji.checked;
      const useKanjiOptions = els.kanjiOptions.checked;

      return picked.map(item=>{
        let prompt, answer, candField;

        if(S.mode==='jp2zh'){
          prompt = displayJP(item, showKanji, katakanaOnly);
          answer = item.zh; candField='zh';
        }else if(S.mode==='zh2jp'){
          prompt = item.zh;
          if(useKanjiOptions && item.kanji){
            candField='kanji'; answer=item.kanji;
          }else{
            candField='jp'; answer=displayJP(item, showKanji, katakanaOnly);
          }
        }else{ // kanji2kana
          prompt = (item.kanji===item.kana)? item.jp : item.kanji;
          candField='kana'; answer = toKatakanaIf(item.kana, katakanaOnly);
        }

        let distractorsRaw = pool.filter(x=>x!==item).map(x=>{
          if(candField==='zh') return x.zh;
          if(candField==='kanji') return x.kanji || x.jp;
          if(candField==='jp') return displayJP(x, showKanji, katakanaOnly);
          return toKatakanaIf(x.kana, katakanaOnly);
        }).filter(Boolean);

        const distractors = sample(distractorsRaw, 3);
        const options = shuffle([answer, ...distractors]);
        return {item, prompt, answer, options, candField};
      });
    }

    // ---- èªéŸ³ ----
    function speak(text, lang='ja-JP'){
      try{
        window.speechSynthesis.cancel();
        const u=new SpeechSynthesisUtterance(text);
        const v=window.speechSynthesis.getVoices();
        const jp=v.find(x=>x.lang && x.lang.startsWith('ja'))||v[0];
        if(jp) u.voice=jp; u.lang=lang;
        window.speechSynthesis.speak(u);
      }catch(e){}
    }

    // ---- HUD/æ¸²æŸ“ ----
    function updateHud(){
      els.score.textContent=S.score; els.streak.textContent=S.streak; els.bar.style.width=`${(S.idx/S.total)*100}%`;
      els.modeTag.textContent = (S.mode==='jp2zh'?'JPâ†’ZH': S.mode==='zh2jp'?'ZHâ†’JP':'æ¼¢â†’ä»®');
      els.meta.textContent = `ç¬¬ ${Math.min(S.idx+1, S.total)} / ${S.total} é¡Œ`;
    }

    function renderQuestion(){
      const q=S.questions[S.idx];
      els.qtext.textContent=q.prompt;
      els.choices.innerHTML=''; els.nextBtn.disabled=true; els.resBox.style.display='none';
      q.options.forEach((opt,i)=>{
        const btn=document.createElement('button'); btn.className='choice';
        btn.innerHTML=`<span class="key">${i+1}</span> <span>${opt}</span>`;
        btn.addEventListener('click',()=>onChoose(opt));
        els.choices.appendChild(btn);
      });
      updateHud();
    }

    function displayAnswerExplain(q, brief=false){
      const it=q.item; const katakanaOnly = els.katakanaOnly.checked; const showKanji = els.showKanji.checked;
      if(q.candField==='zh'){
        const jpShown=displayJP(it, showKanji, katakanaOnly); return brief? it.zh : `${it.zh}ï¼ˆ${jpShown}ï¼‰`;
      }else if(q.candField==='jp'){
        const jpShown=displayJP(it, showKanji, katakanaOnly); if(brief) return jpShown;
        const kanaShown=toKatakanaIf(it.kana, katakanaOnly);
        return (it.kanji!==it.kana) ? `${jpShown}ï¼ˆä¸­æ–‡ï¼š${it.zh}ï½œè®€éŸ³ï¼š${kanaShown}ï¼‰` : `${jpShown}ï¼ˆä¸­æ–‡ï¼š${it.zh}ï¼‰`;
      }else if(q.candField==='kanji'){
        const kanjiShown=it.kanji||it.jp; if(brief) return kanjiShown;
        return `${kanjiShown}ï¼ˆè®€éŸ³ï¼š${toKatakanaIf(it.kana, katakanaOnly)}ï¼ä¸­æ–‡ï¼š${it.zh}ï¼‰`;
      }else{
        const kanaShown=toKatakanaIf(it.kana, katakanaOnly); return brief? `${kanaShown}` : `${kanaShown}ï¼ˆæ¼¢å­—ï¼š${it.kanji}ï¼ä¸­æ–‡ï¼š${it.zh}ï¼‰`;
      }
    }

    function onChoose(opt){
      if(!S.running) return;
      const q=S.questions[S.idx]; const correct=(opt===q.answer);
      $$('.choice', els.choices).forEach(b=>b.disabled=true);
      els.resBox.style.display='block';
      if(correct){
        S.score++; S.streak++; S.bestStreak=Math.max(S.bestStreak,S.streak);
        els.resHead.textContent='âœ… æ­£ç¢ºï¼'; els.resBody.textContent=displayAnswerExplain(q); els.resBox.className='result ok';
        if(els.timed.checked){ S.timeLeft=Math.min(S.timeLeft+3,999); els.timeLeft.textContent=S.timeLeft; }
      }else{
        S.streak=0; els.resHead.textContent='âŒ éŒ¯èª¤'; els.resBody.textContent=`æ­£è§£ï¼š${q.answer}ï¼ˆ${displayAnswerExplain(q,true)}ï¼‰`; els.resBox.className='result bad';
        S.wrongPool.push(q.item);
      }
      els.nextBtn.disabled=false; updateHud();
    }

    function nextQuestion(){ S.idx++; if(S.idx>=S.total){ endQuiz(); } else { renderQuestion(); } }
    function startTimer(){
      els.timeChip.style.display='inline-block'; S.timeLeft=60; els.timeLeft.textContent=S.timeLeft;
      S.timerId=setInterval(()=>{ S.timeLeft--; els.timeLeft.textContent=S.timeLeft; if(S.timeLeft<=0){ clearInterval(S.timerId); endQuiz(); } },1000);
    }
    function stopTimer(){ els.timeChip.style.display='none'; if(S.timerId){ clearInterval(S.timerId); S.timerId=null; } }
    function endQuiz(){
      S.running=false; stopTimer(); els.quiz.style.display='none'; els.summary.style.display='block';
      els.finalScore.textContent=S.score; els.finalTotal.textContent=S.total; els.finalStreak.textContent=S.bestStreak;
      els.retryWrong.disabled=(S.wrongPool.length===0);
      // å­˜ä¸€æ¬¡åˆ†æ•¸ç›¸é—œç„¡éœ€ï¼Œä½†å­˜åå¥½ï¼ˆä»¥é˜²é¡Œæ•¸/æ¨¡å¼æ›´æ–°ï¼‰
      savePrefs();
    }

    // ---- äº‹ä»¶ï¼šæ¨¡å¼/é¡Œæ•¸/é¡¯ç¤ºé¸é … ----
    $$('input[name="mode"]').forEach(r=> r.addEventListener('change',()=>{ S.mode=r.value; savePrefs(); updateHud(); }));
    $$('button[data-q]').forEach(btn=> btn.addEventListener('click',()=>{ S.total=Number(btn.dataset.q); els.qcount.textContent=`ç›®å‰ï¼š${S.total} é¡Œ`; savePrefs(); }));

    // å½±éŸ¿æ¸…å–®é¡¯ç¤ºçš„é¸é …ï¼šå³æ™‚æ›´æ–°ï¼‹å­˜åå¥½
    ['katakanaOnly','showKanji','kanjiOptions','useL1','useL2','useL3','useL4','tagSuffix','tagCountry','tagTime','onlyStar','byLesson','timed']
      .forEach(id=>{ $('#'+id).addEventListener('change',()=>{ savePrefs(); renderBankListsWithSettings(); }); });

    // ---- é–‹å§‹ï¼é‡ä¾†ï¼éŒ¯é¡Œé‡ç·´ ----
    els.startBtn.addEventListener('click',()=>{
      renderBankListsWithSettings(); // åŒæ­¥ä¸€æ¬¡æ¸…å–®é¡¯ç¤º
      S.idx=0; S.score=0; S.streak=0; S.bestStreak=0; S.wrongPool=[];
      S.mode=($('input[name="mode"]:checked')?.value)||S.mode;
      S.questions=buildQuestionPool();
      if(S.questions.length===0){ alert('æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„é¡Œç›®ã€‚\nè«‹èª¿æ•´èª²æ¬¡æˆ–æ¨™ç±¤/æ˜Ÿè™Ÿç¯©é¸ã€‚'); return; }
      S.total=Math.min(S.total,S.questions.length); S.running=true;
      els.setup.style.display='none'; els.summary.style.display='none'; els.quiz.style.display='block';
      els.nextBtn.disabled=true; updateHud(); renderQuestion();
      if(els.timed.checked) startTimer(); else stopTimer();
      savePrefs();
    });

    els.nextBtn.addEventListener('click', nextQuestion);

    els.restart.addEventListener('click',()=>{
      stopTimer(); S.running=false;
      els.quiz.style.display='none'; els.summary.style.display='none'; els.setup.style.display='block';
      renderBankListsWithSettings(); savePrefs();
    });

    els.retryWrong.addEventListener('click',()=>{
      if(S.wrongPool.length===0) return;
      const tmp=S.wrongPool; S.wrongPool=[];
      S.idx=0; S.score=0; S.streak=0; S.bestStreak=0; S.mode=($('input[name="mode"]:checked')?.value)||S.mode;

      const katakanaOnly = els.katakanaOnly.checked;
      const showKanji = els.showKanji.checked;
      const useKanjiOptions = els.kanjiOptions.checked;

      S.questions=tmp.map(item=>{
        let prompt, answer, candField;
        if(S.mode==='jp2zh'){
          prompt = displayJP(item, showKanji, katakanaOnly); answer=item.zh; candField='zh';
        }else if(S.mode==='zh2jp'){
          prompt=item.zh;
          if(useKanjiOptions && item.kanji){ candField='kanji'; answer=item.kanji; }
          else { candField='jp'; answer=displayJP(item, showKanji, katakanaOnly); }
        }else{
          prompt=(item.kanji===item.kana)?item.jp:item.kanji; answer=toKatakanaIf(item.kana, katakanaOnly); candField='kana';
        }
        let distractors=sample(getFilteredBank().filter(x=>x!==item).map(x=>{
          if(candField==='zh') return x.zh;
          if(candField==='kanji') return x.kanji || x.jp;
          if(candField==='jp') return displayJP(x, showKanji, katakanaOnly);
          return toKatakanaIf(x.kana, katakanaOnly);
        }).filter(Boolean),3);
        const options=shuffle([answer,...distractors]);
        return {item,prompt,answer,options,candField};
      });
      S.total=S.questions.length; S.running=true;
      els.setup.style.display='none'; els.summary.style.display='none'; els.quiz.style.display='block';
      if(els.timed.checked) startTimer(); else stopTimer(); renderQuestion();
    });

    // ---- æœ—è®€ ----
    els.speakBtn.addEventListener('click',()=>{
      const q=S.questions[S.idx]; // æœ—è®€ç”¨å‡å
      speak(q.item.kana);
    });

    // ---- éµç›¤å¿«æ·éµ ----
    document.addEventListener('keydown',(e)=>{
      if(els.quiz.style.display==='block' && S.running){
        if(['1','2','3','4'].includes(e.key)){
          const i=Number(e.key)-1; const btn=$$('.choice',els.choices)[i];
          if(btn && !btn.disabled){ btn.click(); }
        }else if(e.key==='Enter'){
          if(!els.nextBtn.disabled){ nextQuestion(); }
        }else if(e.key===' '){
          e.preventDefault();
          const q=S.questions[S.idx]; if(q){ speak(q.item.kana); }
        }
      }
    });

    // ---- åˆå§‹åŒ– ----
    function onReady(){
      loadPrefs();
      renderBankListsWithSettings();
      // é¡Œæ•¸æŒ‰éˆ•ä¹Ÿè¦åŒæ­¥æ–‡å­—
      els.qcount.textContent=`ç›®å‰ï¼š${S.total} é¡Œ`;
    }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', onReady); else onReady();
  </script>
</body>
</html>
