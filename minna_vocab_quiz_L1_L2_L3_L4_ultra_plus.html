<<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>大家的日本語 N5｜L1–L4 單字小考（固定題庫）</title>
  <style>
    :root{ --bg1:#fff6dc; --bg2:#ffeec5; --paper:#fff7da; --ink:#1d1608; --accent:#d9983d; --accent-d:#b67a2f; --ok:#2e7d32; --bad:#c62828; --shadow:0 10px 20px rgba(0,0,0,.08); }
    html,body{height:100%}
    body{margin:0;font-family: ui-rounded,"SF Pro Rounded",-apple-system,system-ui,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif;color:var(--ink);
      background: radial-gradient(120% 120% at 0% 0%, var(--bg1), var(--bg2));
      background-attachment:fixed; -webkit-tap-highlight-color: transparent;}
    .app{min-height:100dvh;display:flex;flex-direction:column}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 14px;background:#ffffffb3;backdrop-filter: blur(6px);border-bottom:1px dashed rgba(0,0,0,.08)}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:14px;background:var(--paper);display:grid;place-items:center;font-weight:900;color:var(--accent);box-shadow:inset 0 0 0 2px rgba(0,0,0,.06)}
    .title{font-weight:900;color:var(--accent)}
    .hud{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .chip{background:var(--paper);padding:6px 10px;border-radius:999px;font-weight:900;box-shadow:var(--shadow)}
    .home-link{ text-decoration:none;background:#fff;color:var(--accent);font-weight:900;border-radius:999px;padding:6px 12px;box-shadow:inset 0 0 0 2px var(--accent);transition:background .1s }
    .home-link:hover{background:var(--paper)}
    main{flex:1;padding:14px;display:flex}
    .card{margin:auto;width:min(1000px,100%);background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:18px;box-shadow:var(--shadow);padding:16px 14px}
    .section{display:flex;flex-direction:column;gap:12px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:900;box-shadow:0 6px 0 var(--accent-d)}
    .btn:active{transform:translateY(2px);box-shadow:0 4px 0 var(--accent-d)}
    .ghost{background:#fff;color:var(--accent);box-shadow: inset 0 0 0 2px var(--accent)}
    .pill{background:#fff;border:1px solid rgba(0,0,0,.08);padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800}
    .title2{font-weight:900;color:#5f430e}
    .qtext{display:flex;align-items:center;gap:10px;font-size:1.6rem;font-weight:900;line-height:1.6;word-break:keep-all}
    .starbtn{border:0;background:transparent;font-size:1.4rem;cursor:pointer}
    .choices{display:grid;grid-template-columns:1fr;gap:10px}
    .choice{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:14px 12px;font-size:1.1rem;font-weight:800;box-shadow:var(--shadow)}
    .choice:active{transform:scale(.99)}
    .key{min-width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:var(--paper);color:var(--accent);border:1px solid rgba(0,0,0,.06)}
    .result{margin-top:10px;padding:10px;border-radius:12px;border:2px dashed rgba(0,0,0,.12);display:none}
    .result.ok{border-color:#7cb34266}
    .result.bad{border-color:#e5393566}
    footer{position:sticky;bottom:0;z-index:10;padding:8px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px;background:#ffffffb3;backdrop-filter: blur(6px);border-top:1px dashed rgba(0,0,0,.08)}
    .meter{flex:1;display:flex;gap:10px;align-items:center}
    .progress{height:12px;background:#fff;border:1px solid rgba(0,0,0,.1);border-radius:999px;overflow:hidden;flex:1}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#d9983d,#f7c66d)}
    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:8px}
    .item{background:var(--paper);padding:10px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .hint{opacity:.85;font-size:.95rem}
    .lesson-note{margin:6px 0 2px;font-weight:800;opacity:.9}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">単</div>
        <div class="title">大家的日本語 N5｜L1–L4 單字小考（固定題庫）</div>
      </div>
      <div class="hud">
        <div class="chip">分數 <span id="score">0</span></div>
        <div class="chip">連對 <span id="streak">0</span></div>
        <div class="chip" id="timeChip" style="display:none">⏱ <span id="timeLeft">60</span>s</div>
        <a href="#" class="home-link" onclick="location.reload()">🏠 回首頁</a>
      </div>
    </header>
    <main>
      <section class="card section" id="setup">
        <div class="title2">模式</div>
        <div class="grid">
          <label class="row"><input type="radio" name="mode" value="jp2zh" checked> <span class="pill">看到日文 → 選中文</span></label>
          <label class="row"><input type="radio" name="mode" value="zh2jp"> <span class="pill">看到中文 → 選日文</span></label>
          <label class="row"><input type="radio" name="mode" value="kanji2kana"> <span class="pill">讀音模式：漢字 → 假名</span></label>
        </div>

        <div class="title2">範圍</div>
        <div class="row">
          <label class="pill"><input type="checkbox" id="useL1" checked> L1</label>
          <label class="pill"><input type="checkbox" id="useL2" checked> L2</label>
          <label class="pill"><input type="checkbox" id="useL3" checked> L3</label>
          <label class="pill"><input type="checkbox" id="useL4" checked> L4</label>
        </div>

        <div class="title2">標籤篩選</div>
        <div class="row">
          <label class="pill"><input type="checkbox" id="tagSuffix"> 接尾詞</label>
          <label class="pill"><input type="checkbox" id="tagCountry"> 國家</label>
          <label class="pill"><input type="checkbox" id="tagTime"> 時間類</label>
          <span class="pill"><input type="checkbox" id="onlyStar"> 只出 ⭐️ 星號單字</span>
        </div>

        <div class="title2">題數 & 顯示</div>
        <div class="row">
          <button class="pill" data-q="10">10 題</button>
          <button class="pill" data-q="20">20 題</button>
          <span id="qcount" class="pill">目前：10 題</span>
        </div>
        <div class="row">
          <label class="pill"><input type="checkbox" id="timed"> 限時模式（60 秒，連對 +3 秒）</label>
          <label class="pill"><input type="checkbox" id="byLesson"> 依課次順序（關閉＝隨機混合）</label>
          <label class="pill"><input type="checkbox" id="katakanaOnly"> 只顯示片假名</label>
          <label class="pill"><input type="checkbox" id="showKanji" checked> 顯示漢字</label>
          <label class="pill"><input type="checkbox" id="kanjiOptions"> ZH→JP 選項用「漢字」</label>
        </div>

        <details>
          <summary>題庫一覽（可直接加星）</summary>

          <div class="title2" style="margin-top:6px">L1</div>
          <div class="lesson-note">🟡 第1課：自我介紹與國籍</div>
          <div class="list" id="bankL1"></div>

          <div class="title2" style="margin-top:10px">L2</div>
          <div class="lesson-note">🟡 第2課：指示詞與物品名稱</div>
          <div class="list" id="bankL2"></div>

          <div class="title2" style="margin-top:10px">L3</div>
          <div class="lesson-note">🟡 第3課：場所與方向、樓層與價格</div>
          <div class="list" id="bankL3"></div>

          <div class="title2" style="margin-top:10px">L4</div>
          <div class="lesson-note">🟡 第4課：時間（時・分・上午/下午）、星期</div>
          <div class="list" id="bankL4"></div>
        </details>

        <div class="row"><button class="btn" id="startBtn">開始測驗 ▶</button></div>
      </section>

      <section class="card section" id="quiz" style="display:none">
        <div class="row"><span class="pill" id="meta">第 1 / 10 題</span><span class="pill" id="modeTag">JP→ZH</span></div>
        <div class="qtext" id="qtext">問題</div>
        <div class="choices" id="choices"></div>
        <div class="result" id="resultBox">
          <div id="resHead" style="font-weight:900;margin-bottom:4px"></div>
          <div id="resBody"></div>
        </div>
        <div class="row">
          <button class="btn" id="nextBtn" disabled>下一題 →</button>
          <button class="ghost" id="speakBtn">朗讀</button>
        </div>
      </section>

      <section class="card section" id="summary" style="display:none">
        <div class="title2">完成！</div>
        <div>分數：<b id="finalScore">0</b> ／ 題數：<b id="finalTotal">0</b></div>
        <div>最佳連對：<b id="finalStreak">0</b></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="retryWrong" disabled>錯題重練 ▶</button>
          <button class="ghost" id="restart">回到設定頁</button>
        </div>
      </section>
    </main>

    <footer>
      <div class="meter">
        <span class="pill">進度</span>
        <div class="progress"><div class="bar" id="bar"></div></div>
      </div>
    </footer>
  </div>

  <script>
    const T = { SUFFIX:"接尾詞", COUNTRY:"國家", TIME:"時間" };
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];

    // ---- 偏好儲存鍵 ----
    const PREF_KEY = 'n5_l1_4_prefs_v1';
    const STAR_KEY = 'n5_fixed_bank_stars_v1';

    // ---- 解析工具 ----
    function parseKanjiKanaFlexible(jp){
      let m = jp.match(/^(.*)（(.*)）$/);
      if(m){ return {kana:m[1], kanji:m[2]} }
      m = jp.match(/^(.*)\((.*)\)$/);
      if(m){ return {kana:m[1], kanji:m[2]} }
      return {kana:jp, kanji:jp};
    }
    function hiraToKata(str){ return str.replace(/[ぁ-ゖ]/g, ch => String.fromCharCode(ch.charCodeAt(0)+0x60)); }
    function toKatakanaIf(s,on){ return on ? hiraToKata(s) : s; }

    // ---- 顯示工具 ----
    function displayKana(word, katakanaOn){
      const k = word.kana || word.jp;
      return katakanaOn ? hiraToKata(k) : k;
    }
    function displayJP(word, showKanji, katakanaOn){
      if(!showKanji){ return displayKana(word, katakanaOn); }
      if(word.kanji && word.kana && word.kanji!==word.kana){
        return `${displayKana(word, katakanaOn)}（${word.kanji}）`;
      }
      const s = word.jp || word.kana;
      return katakanaOn ? hiraToKata(s) : s;
    }

    // ---- 題庫 ----
    const L1_RAW = [
      ["わたし","我",[]],["あなた","你、您",[]],["あのひと（あの人）","他、她、那個人",[]],["あのかた（あの方）","「あの人」的禮貌說法",[]],
      ["〜さん","〜先生、〜小姐、〜女士（接尾）",[T.SUFFIX]],["〜ちゃん","代替「〜さん」，接在小孩子名字後（接尾）",[T.SUFFIX]],["〜じん","〜人（表示國籍的接尾詞）",[T.SUFFIX]],
      ["せんせい（先生）","老師",[]],["きょうし（教師）","教師",[]],["がくせい（学生）","學生",[]],["かいしゃいん（会社員）","公司職員",[]],["しゃいん（社員）","公司職員",[]],
      ["ぎんこういん（銀行員）","銀行行員",[]],["いしゃ（医者）","醫生",[]],["けんきゅうしゃ（研究者）","研究人員",[]],["だいがく（大学）","大學",[]],["びょういん（病院）","醫院",[]],
      ["だれ（誰）","誰（哪位）",[]],["どなた","「だれ」的禮貌說法",[]],["〜さい（〜歳）","〜歲",[]],["なんさい（何歳）","幾歲",[]],["おいくつ","「なんさい」的禮貌說法",[]],
      ["はい","是、對",[]],["いいえ","不、不是",[]],["はじめまして。","初次見面。",[]],["〜からきました。","從〜來的。",[]],["どうぞよろしくおねがいします。","請多關照／請多指教。",[]],
      ["しつれいですが（失礼ですが）","抱歉，請問…",[]],["おなまえは？（お名前は？）","您貴姓？您叫什麼名字？",[]],["こちらは〜さんです。","這位是〜。",[]],
      ["アメリカ","美國",[T.COUNTRY]],["イギリス","英國",[T.COUNTRY]],["インド","印度",[T.COUNTRY]],["インドネシア","印尼",[T.COUNTRY]],["かんこく（韓国）","韓國",[T.COUNTRY]],
      ["タイ","泰國",[T.COUNTRY]],["ちゅうごく（中国）","中國",[T.COUNTRY]],["ドイツ","德國",[T.COUNTRY]],["にほん（日本）","日本",[T.COUNTRY]],["ブラジル","巴西",[T.COUNTRY]]
    ];
    const L2_RAW = [
      ["これ","這(離說話者近的東西)",[]],["それ","那(離聽者近的東西)",[]],["あれ","那(離說話者、聽者都遠的東西)",[]],["この〜","這個~",[]],["その〜","那個~（近對方）",[]],["あの〜","那個~（遠）",[]],
      ["ほん（本）","書",[]],["じしょ（辞書）","字典",[]],["ざっし（雑誌）","雜誌",[]],["しんぶん（新聞）","報紙",[]],["ノート","筆記本",[]],["てちょう（手帳）","記事本",[]],["めいし（名刺）","名片",[]],
      ["カード","卡片",[]],["えんぴつ（鉛筆）","鉛筆",[]],["ボールペン","原子筆",[]],["シャープペンシル","自動鉛筆",[]],["かぎ","鑰匙",[]],["とけい（時計）","鐘錶",[]],["かさ（傘）","傘",[]],
      ["かばん","皮包、提包",[]],["シーディー（CD）","CD、光碟",[]],["テレビ","電視",[]],["ラジオ","收音機",[]],["カメラ","照相機",[]],["コンピューター","電腦",[]],["くるま（車）","汽車",[]],
      ["つくえ（机）","桌子",[]],["いす","椅子",[]],["チョコレート","巧克力",[]],["コーヒー","咖啡",[]],["[お]みやげ","伴手禮、土產",[]],["えいご（英語）","英語",[]],
      ["にほんご（日本語）","日語",[]],["〜ご（〜語）","〜語",[]],["なん（何）","什麼",[]],["そうです","是的",[]],["これからお世話になります。","今後將承蒙您的照顧。",[]],
      ["こちらこそ[どうぞ]よろしく[お願いします]。","哪裡哪裡，也請您多多指教。",[]],["あのう","那個⋯（客氣、躊躇地搭話）",[]],["えっ。","咦⋯（聽到意外消息時）",[]],["どうぞ。","請。（勸對方…）",[]]
    ];
    const L3_RAW = [
      ["ここ","這裡",[]],["そこ","那裡",[]],["あそこ","那邊",[]],["どこ","哪裡",[]],
      ["こちら","這邊（禮貌）",[]],["そちら","那邊（禮貌）",[]],["あちら","那邊（禮貌）",[]],["どちら","哪邊（禮貌）",[]],
      ["きょうしつ（教室）","教室",[]],["しょくどう（食堂）","餐廳",[]],["じむしょ（事務所）","辦公室",[]],["かいぎしつ（会議室）","會議室",[]],
      ["うけつけ（受付）","接待處",[]],["ロビー","大廳",[]],["へや（部屋）","房間",[]],["トイレ","廁所",[]],
      ["かいだん（階段）","樓梯",[]],["エレベーター","電梯",[]],["エスカレーター","手扶梯",[]],["じどうはんばいき（自動販売機）","自動販賣機",[]],
      ["でんわ（電話）","電話",[]],["くに（国）","國家",[T.COUNTRY]],["かいしゃ（会社）","公司",[]],["うち","家",[]],
      ["くつ（靴）","鞋子",[]],["ネクタイ","領帶",[]],["ワイン","紅酒",[]],["うりば（売り場）","賣場",[]],["ちか（地下）","地下",[]],
      ["なんがい（何階）","幾樓",[]],["〜えん（〜円）","〜圓",[]],["いくら","多少錢",[]],
      ["ひゃく（百）","一百",[]],["せん（千）","一千",[]],["まん（万）","一萬",[]]
    ];
    const L4_RAW = [
      ["おきます（起きます）","起床",[]],["ねます（寝ます）","睡覺",[]],["はたらきます（働きます）","工作",[]],["やすみます（休みます）","休息",[]],
      ["べんきょうします（勉強します）","念書",[]],["おわります（終わります）","結束",[]],
      ["デパート","百貨公司",[]],["ぎんこう（銀行）","銀行",[]],["ゆうびんきょく（郵便局）","郵局",[]],
      ["としょかん（図書館）","圖書館",[]],["びじゅつかん（美術館）","美術館",[]],
      ["いま（今）","現在",[T.TIME]],["〜じ（〜時）","〜點鐘",[T.TIME]],["〜ふん（〜分）","〜分",[T.TIME]],["はん（半）","半",[T.TIME]],
      ["なんじ（何時）","幾點",[T.TIME]],["なんぷん（何分）","幾分",[T.TIME]],
      ["ごぜん（午前）","上午",[T.TIME]],["ごご（午後）","下午",[T.TIME]],["あさ（朝）","早上",[T.TIME]],
      ["ひる（昼）","中午",[T.TIME]],["ばん（晩）／よる（夜）","晚上",[T.TIME]],["けさ（今朝）","今天早上",[T.TIME]],["こんばん（今晩）","今天晚上",[T.TIME]],
      ["やすみ（休み）","休假",[]],["ひるやすみ（昼休み）","午休",[]],
      ["まいあさ（毎朝）","每天早上",[T.TIME]],["まいばん（毎晩）","每天晚上",[T.TIME]],["まいにち（毎日）","每天",[T.TIME]],
      ["げつようび（月曜日）","星期一",[]],["かようび（火曜日）","星期二",[]],["すいようび（水曜日）","星期三",[]],
      ["もくようび（木曜日）","星期四",[]],["きんようび（金曜日）","星期五",[]],
      ["どようび（土曜日）","星期六",[]],["にちようび（日曜日）","星期日",[]],["なんようび（何曜日）","星期幾",[]],
      ["ばんごう（番号）","號碼",[]],["なんばん（何番）","幾號",[]]
    ];

    function normalize(raw, lesson){
      return raw.map(([jp, zh, tags])=>{
        const {kana, kanji} = parseKanjiKanaFlexible(jp);
        return { jp, kana, kanji, zh, tags: tags||[], lesson };
      });
    }
    const BANK_ALL = [...normalize(L1_RAW,'L1'),...normalize(L2_RAW,'L2'),...normalize(L3_RAW,'L3'),...normalize(L4_RAW,'L4')];

    // ---- 星號收藏 ----
    const starSet=new Set(JSON.parse(localStorage.getItem(STAR_KEY)||'[]'));
    function saveStars(){ localStorage.setItem(STAR_KEY, JSON.stringify([...starSet])); }
    function isStarred(item){ return starSet.has(item.jp+'|'+item.zh); }

    // ---- DOM ----
    const els = {
      setup:$('#setup'), quiz:$('#quiz'), summary:$('#summary'),
      qtext:$('#qtext'), choices:$('#choices'), nextBtn:$('#nextBtn'), speakBtn:$('#speakBtn'),
      resBox:$('#resultBox'), resHead:$('#resHead'), resBody:$('#resBody'),
      meta:$('#meta'), modeTag:$('#modeTag'), bar:$('#bar'),
      score:$('#score'), streak:$('#streak'),
      timeChip:$('#timeChip'), timeLeft:$('#timeLeft'),
      finalScore:$('#finalScore'), finalTotal:$('#finalTotal'), finalStreak:$('#finalStreak'),
      retryWrong:$('#retryWrong'), restart:$('#restart'),
      qcount:$('#qcount'), startBtn:$('#startBtn'),
      useL1:$('#useL1'), useL2:$('#useL2'), useL3:$('#useL3'), useL4:$('#useL4'),
      tagSuffix:$('#tagSuffix'), tagCountry:$('#tagCountry'), tagTime:$('#tagTime'),
      onlyStar:$('#onlyStar'), byLesson:$('#byLesson'), timed:$('#timed'),
      katakanaOnly:$('#katakanaOnly'), showKanji:$('#showKanji'), kanjiOptions:$('#kanjiOptions'),
      bankL1:$('#bankL1'), bankL2:$('#bankL2'), bankL3:$('#bankL3'), bankL4:$('#bankL4'),
    };

    // ---- 狀態 ----
    const S={mode:'jp2zh', total:10, idx:0, score:0, streak:0, bestStreak:0, questions:[], wrongPool:[], timeLeft:60, timerId:null, running:false};

    // ---- 偏好存取 ----
    function savePrefs(){
      const prefs = {
        // 範圍
        useL1:els.useL1.checked, useL2:els.useL2.checked, useL3:els.useL3.checked, useL4:els.useL4.checked,
        // 標籤
        tagSuffix:els.tagSuffix.checked, tagCountry:els.tagCountry.checked, tagTime:els.tagTime.checked, onlyStar:els.onlyStar.checked,
        // 顯示
        timed:els.timed.checked, byLesson:els.byLesson.checked, katakanaOnly:els.katakanaOnly.checked, showKanji:els.showKanji.checked, kanjiOptions:els.kanjiOptions.checked,
        // 其他
        total:S.total, mode:S.mode
      };
      localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
    }
    function loadPrefs(){
      try{
        const raw = localStorage.getItem(PREF_KEY);
        if(!raw) return;
        const p = JSON.parse(raw);
        // 套用 checkbox
        ['useL1','useL2','useL3','useL4','tagSuffix','tagCountry','tagTime','onlyStar','timed','byLesson','katakanaOnly','showKanji','kanjiOptions'].forEach(k=>{
          if(typeof p[k]==='boolean'){ els[k].checked = p[k]; }
        });
        if(typeof p.total==='number'){ S.total=p.total; els.qcount.textContent=`目前：${S.total} 題`; }
        if(typeof p.mode==='string'){ S.mode=p.mode; const r=document.querySelector(`input[name="mode"][value="${S.mode}"]`); if(r) r.checked=true; }
      }catch(e){}
    }

    // ---- 題庫清單（顯示）----
    function renderBankList(container, items){
      const katakanaOnly = els.katakanaOnly.checked;
      const showKanji = els.showKanji.checked;
      container.innerHTML='';
      items.forEach(item=>{
        const id=item.jp+'|'+item.zh;
        const div=document.createElement('div'); div.className='item';
        const left=document.createElement('div'); left.style.display='grid'; left.style.gap='2px';

        const top=document.createElement('div'); top.style.fontWeight='900';
        top.textContent = displayJP(item, showKanji, katakanaOnly);

        const mid=document.createElement('div'); mid.className='hint'; mid.textContent=`中文：${item.zh}`;

        const tag=document.createElement('div'); tag.className='hint';
        if(item.kanji!==item.kana){ tag.textContent=`讀音：${toKatakanaIf(item.kana, katakanaOnly)}／漢字：${item.kanji}`; }
        else { tag.textContent=`讀音：${toKatakanaIf(item.kana, katakanaOnly)}`; }

        left.append(top, mid, tag);

        const star=document.createElement('button'); star.className='starbtn'; star.innerHTML=isStarred(item)?'⭐️':'☆';
        star.addEventListener('click',()=>{ if(isStarred(item)){ starSet.delete(id); star.innerHTML='☆'; } else { starSet.add(id); star.innerHTML='⭐️'; } saveStars(); });

        div.append(left,star); container.appendChild(div);
      });
    }
    function renderBankListsWithSettings(){
      renderBankList(els.bankL1, BANK_ALL.filter(x=>x.lesson==='L1'));
      renderBankList(els.bankL2, BANK_ALL.filter(x=>x.lesson==='L2'));
      renderBankList(els.bankL3, BANK_ALL.filter(x=>x.lesson==='L3'));
      renderBankList(els.bankL4, BANK_ALL.filter(x=>x.lesson==='L4'));
    }

    // ---- 工具 ----
    function sample(arr,n){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a.slice(0,n); }
    function shuffle(arr){ return sample(arr, arr.length); }

    function getFilteredBank(){
      const use=new Set(); if(els.useL1.checked)use.add('L1'); if(els.useL2.checked)use.add('L2'); if(els.useL3.checked)use.add('L3'); if(els.useL4.checked)use.add('L4');
      const wantS=els.tagSuffix.checked, wantC=els.tagCountry.checked, wantT=els.tagTime.checked, onlyStar=els.onlyStar.checked;
      return BANK_ALL.filter(it=>{
        if(!use.has(it.lesson)) return false;
        if(onlyStar && !isStarred(it)) return false;
        const any=wantS||wantC||wantT;
        if(any){
          const set=new Set(it.tags);
          if(wantS&&set.has(T.SUFFIX)) return true;
          if(wantC&&set.has(T.COUNTRY)) return true;
          if(wantT&&set.has(T.TIME)) return true;
          return false;
        }
        return true;
      });
    }

    // ---- 出題 ----
    function buildQuestionPool(){
      const pool=getFilteredBank(); if(pool.length===0) return [];
      const picked = els.byLesson.checked
        ? ['L1','L2','L3','L4'].flatMap(L=>shuffle(pool.filter(x=>x.lesson===L))).slice(0,S.total)
        : sample(pool, Math.min(S.total, pool.length));

      const katakanaOnly = els.katakanaOnly.checked;
      const showKanji = els.showKanji.checked;
      const useKanjiOptions = els.kanjiOptions.checked;

      return picked.map(item=>{
        let prompt, answer, candField;

        if(S.mode==='jp2zh'){
          prompt = displayJP(item, showKanji, katakanaOnly);
          answer = item.zh; candField='zh';
        }else if(S.mode==='zh2jp'){
          prompt = item.zh;
          if(useKanjiOptions && item.kanji){
            candField='kanji'; answer=item.kanji;
          }else{
            candField='jp'; answer=displayJP(item, showKanji, katakanaOnly);
          }
        }else{ // kanji2kana
          prompt = (item.kanji===item.kana)? item.jp : item.kanji;
          candField='kana'; answer = toKatakanaIf(item.kana, katakanaOnly);
        }

        let distractorsRaw = pool.filter(x=>x!==item).map(x=>{
          if(candField==='zh') return x.zh;
          if(candField==='kanji') return x.kanji || x.jp;
          if(candField==='jp') return displayJP(x, showKanji, katakanaOnly);
          return toKatakanaIf(x.kana, katakanaOnly);
        }).filter(Boolean);

        const distractors = sample(distractorsRaw, 3);
        const options = shuffle([answer, ...distractors]);
        return {item, prompt, answer, options, candField};
      });
    }

    // ---- 語音 ----
    function speak(text, lang='ja-JP'){
      try{
        window.speechSynthesis.cancel();
        const u=new SpeechSynthesisUtterance(text);
        const v=window.speechSynthesis.getVoices();
        const jp=v.find(x=>x.lang && x.lang.startsWith('ja'))||v[0];
        if(jp) u.voice=jp; u.lang=lang;
        window.speechSynthesis.speak(u);
      }catch(e){}
    }

    // ---- HUD/渲染 ----
    function updateHud(){
      els.score.textContent=S.score; els.streak.textContent=S.streak; els.bar.style.width=`${(S.idx/S.total)*100}%`;
      els.modeTag.textContent = (S.mode==='jp2zh'?'JP→ZH': S.mode==='zh2jp'?'ZH→JP':'漢→仮');
      els.meta.textContent = `第 ${Math.min(S.idx+1, S.total)} / ${S.total} 題`;
    }

    function renderQuestion(){
      const q=S.questions[S.idx];
      els.qtext.textContent=q.prompt;
      els.choices.innerHTML=''; els.nextBtn.disabled=true; els.resBox.style.display='none';
      q.options.forEach((opt,i)=>{
        const btn=document.createElement('button'); btn.className='choice';
        btn.innerHTML=`<span class="key">${i+1}</span> <span>${opt}</span>`;
        btn.addEventListener('click',()=>onChoose(opt));
        els.choices.appendChild(btn);
      });
      updateHud();
    }

    function displayAnswerExplain(q, brief=false){
      const it=q.item; const katakanaOnly = els.katakanaOnly.checked; const showKanji = els.showKanji.checked;
      if(q.candField==='zh'){
        const jpShown=displayJP(it, showKanji, katakanaOnly); return brief? it.zh : `${it.zh}（${jpShown}）`;
      }else if(q.candField==='jp'){
        const jpShown=displayJP(it, showKanji, katakanaOnly); if(brief) return jpShown;
        const kanaShown=toKatakanaIf(it.kana, katakanaOnly);
        return (it.kanji!==it.kana) ? `${jpShown}（中文：${it.zh}｜讀音：${kanaShown}）` : `${jpShown}（中文：${it.zh}）`;
      }else if(q.candField==='kanji'){
        const kanjiShown=it.kanji||it.jp; if(brief) return kanjiShown;
        return `${kanjiShown}（讀音：${toKatakanaIf(it.kana, katakanaOnly)}／中文：${it.zh}）`;
      }else{
        const kanaShown=toKatakanaIf(it.kana, katakanaOnly); return brief? `${kanaShown}` : `${kanaShown}（漢字：${it.kanji}／中文：${it.zh}）`;
      }
    }

    function onChoose(opt){
      if(!S.running) return;
      const q=S.questions[S.idx]; const correct=(opt===q.answer);
      $$('.choice', els.choices).forEach(b=>b.disabled=true);
      els.resBox.style.display='block';
      if(correct){
        S.score++; S.streak++; S.bestStreak=Math.max(S.bestStreak,S.streak);
        els.resHead.textContent='✅ 正確！'; els.resBody.textContent=displayAnswerExplain(q); els.resBox.className='result ok';
        if(els.timed.checked){ S.timeLeft=Math.min(S.timeLeft+3,999); els.timeLeft.textContent=S.timeLeft; }
      }else{
        S.streak=0; els.resHead.textContent='❌ 錯誤'; els.resBody.textContent=`正解：${q.answer}（${displayAnswerExplain(q,true)}）`; els.resBox.className='result bad';
        S.wrongPool.push(q.item);
      }
      els.nextBtn.disabled=false; updateHud();
    }

    function nextQuestion(){ S.idx++; if(S.idx>=S.total){ endQuiz(); } else { renderQuestion(); } }
    function startTimer(){
      els.timeChip.style.display='inline-block'; S.timeLeft=60; els.timeLeft.textContent=S.timeLeft;
      S.timerId=setInterval(()=>{ S.timeLeft--; els.timeLeft.textContent=S.timeLeft; if(S.timeLeft<=0){ clearInterval(S.timerId); endQuiz(); } },1000);
    }
    function stopTimer(){ els.timeChip.style.display='none'; if(S.timerId){ clearInterval(S.timerId); S.timerId=null; } }
    function endQuiz(){
      S.running=false; stopTimer(); els.quiz.style.display='none'; els.summary.style.display='block';
      els.finalScore.textContent=S.score; els.finalTotal.textContent=S.total; els.finalStreak.textContent=S.bestStreak;
      els.retryWrong.disabled=(S.wrongPool.length===0);
      // 存一次分數相關無需，但存偏好（以防題數/模式更新）
      savePrefs();
    }

    // ---- 事件：模式/題數/顯示選項 ----
    $$('input[name="mode"]').forEach(r=> r.addEventListener('change',()=>{ S.mode=r.value; savePrefs(); updateHud(); }));
    $$('button[data-q]').forEach(btn=> btn.addEventListener('click',()=>{ S.total=Number(btn.dataset.q); els.qcount.textContent=`目前：${S.total} 題`; savePrefs(); }));

    // 影響清單顯示的選項：即時更新＋存偏好
    ['katakanaOnly','showKanji','kanjiOptions','useL1','useL2','useL3','useL4','tagSuffix','tagCountry','tagTime','onlyStar','byLesson','timed']
      .forEach(id=>{ $('#'+id).addEventListener('change',()=>{ savePrefs(); renderBankListsWithSettings(); }); });

    // ---- 開始／重來／錯題重練 ----
    els.startBtn.addEventListener('click',()=>{
      renderBankListsWithSettings(); // 同步一次清單顯示
      S.idx=0; S.score=0; S.streak=0; S.bestStreak=0; S.wrongPool=[];
      S.mode=($('input[name="mode"]:checked')?.value)||S.mode;
      S.questions=buildQuestionPool();
      if(S.questions.length===0){ alert('沒有符合篩選條件的題目。\n請調整課次或標籤/星號篩選。'); return; }
      S.total=Math.min(S.total,S.questions.length); S.running=true;
      els.setup.style.display='none'; els.summary.style.display='none'; els.quiz.style.display='block';
      els.nextBtn.disabled=true; updateHud(); renderQuestion();
      if(els.timed.checked) startTimer(); else stopTimer();
      savePrefs();
    });

    els.nextBtn.addEventListener('click', nextQuestion);

    els.restart.addEventListener('click',()=>{
      stopTimer(); S.running=false;
      els.quiz.style.display='none'; els.summary.style.display='none'; els.setup.style.display='block';
      renderBankListsWithSettings(); savePrefs();
    });

    els.retryWrong.addEventListener('click',()=>{
      if(S.wrongPool.length===0) return;
      const tmp=S.wrongPool; S.wrongPool=[];
      S.idx=0; S.score=0; S.streak=0; S.bestStreak=0; S.mode=($('input[name="mode"]:checked')?.value)||S.mode;

      const katakanaOnly = els.katakanaOnly.checked;
      const showKanji = els.showKanji.checked;
      const useKanjiOptions = els.kanjiOptions.checked;

      S.questions=tmp.map(item=>{
        let prompt, answer, candField;
        if(S.mode==='jp2zh'){
          prompt = displayJP(item, showKanji, katakanaOnly); answer=item.zh; candField='zh';
        }else if(S.mode==='zh2jp'){
          prompt=item.zh;
          if(useKanjiOptions && item.kanji){ candField='kanji'; answer=item.kanji; }
          else { candField='jp'; answer=displayJP(item, showKanji, katakanaOnly); }
        }else{
          prompt=(item.kanji===item.kana)?item.jp:item.kanji; answer=toKatakanaIf(item.kana, katakanaOnly); candField='kana';
        }
        let distractors=sample(getFilteredBank().filter(x=>x!==item).map(x=>{
          if(candField==='zh') return x.zh;
          if(candField==='kanji') return x.kanji || x.jp;
          if(candField==='jp') return displayJP(x, showKanji, katakanaOnly);
          return toKatakanaIf(x.kana, katakanaOnly);
        }).filter(Boolean),3);
        const options=shuffle([answer,...distractors]);
        return {item,prompt,answer,options,candField};
      });
      S.total=S.questions.length; S.running=true;
      els.setup.style.display='none'; els.summary.style.display='none'; els.quiz.style.display='block';
      if(els.timed.checked) startTimer(); else stopTimer(); renderQuestion();
    });

    // ---- 朗讀 ----
    els.speakBtn.addEventListener('click',()=>{
      const q=S.questions[S.idx]; // 朗讀用假名
      speak(q.item.kana);
    });

    // ---- 鍵盤快捷鍵 ----
    document.addEventListener('keydown',(e)=>{
      if(els.quiz.style.display==='block' && S.running){
        if(['1','2','3','4'].includes(e.key)){
          const i=Number(e.key)-1; const btn=$$('.choice',els.choices)[i];
          if(btn && !btn.disabled){ btn.click(); }
        }else if(e.key==='Enter'){
          if(!els.nextBtn.disabled){ nextQuestion(); }
        }else if(e.key===' '){
          e.preventDefault();
          const q=S.questions[S.idx]; if(q){ speak(q.item.kana); }
        }
      }
    });

    // ---- 初始化 ----
    function onReady(){
      loadPrefs();
      renderBankListsWithSettings();
      // 題數按鈕也要同步文字
      els.qcount.textContent=`目前：${S.total} 題`;
    }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', onReady); else onReady();
  </script>
</body>
</html>
